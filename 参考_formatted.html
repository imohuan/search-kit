<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>鏈湴鏂囨。鏅烘悳 Pro</title>

    <!-- 鏍稿績渚濊禆 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@vueuse/shared"></script>
    <script src="https://unpkg.com/@vueuse/core"></script>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>

    <!-- 鍥炬爣搴?-->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- 鏂囦欢瑙ｆ瀽搴?-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Word 瑙ｆ瀽渚濊禆 (浠呬繚鐣?JSZip, 绉婚櫎 docx-preview) -->
    <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>



    <!-- Tailwind 閰嶇疆 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' },
                        indigo: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* 鑷畾涔夊叏灞€鏍峰紡 */
        body {
            background-color: #f8fafc;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }

        /* 闅愯棌婊氬姩鏉′絾淇濈暀鍔熻兘 */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 楂樹寒鏍峰紡 */
        mark.highlight {
            background-color: #fef08a;
            /* yellow-200 */
            color: #854d0e;
            /* yellow-800 */
            padding: 0 2px;
            border-radius: 2px;
            font-weight: 600;
            border-bottom: 2px solid #eab308;
        }

        /* 鍔ㄧ敾 */
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.2s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        .slide-up-enter-active,
        .slide-up-leave-active {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .slide-up-enter-from,
        .slide-up-leave-to {
            transform: translateY(100%);
        }

        /* 鑷畾涔夋粴鍔ㄦ潯鏍峰紡 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* 淇 docx-preview 鍘熺増娓叉煋鏍峰紡鍐茬獊 */
        .docx-wrapper {
            background: transparent !important;
            padding: 0 !important;
        }

        .docx-wrapper>section.docx {
            background: white !important;
            box-shadow: none !important;
            margin-bottom: 0 !important;
            padding: 20px !important;
            /* 杩樺師 Word 椤佃竟璺?*/
            min-height: auto !important;
        }

        /* 寮哄埗 docx 娈佃惤鍧楃骇鏄剧ず */
        .docx-p {
            display: block !important;
            min-height: 1.5em;
            margin-bottom: 0.8em;
            line-height: 1.6;
            word-wrap: break-word;
        }

        /* 绾枃鏈崲琛屾敮鎸?*/
        .plain-text-content {
            white-space: pre-line;
            word-wrap: break-word;
        }

        /* Docx 鎹㈣鏍囩寮哄埗鎹㈣ */
        .docx-br {
            display: block;
            content: "";
            margin-bottom: 0.3em;
        }

        /* 鏂囨。瀵屾枃鏈瑙堟牱寮?(Prose) */
        .doc-content-render {
            color: #334155;
            line-height: 1.8;
            word-break: break-word;
        }

        .doc-content-render p {
            margin-bottom: 1em;
        }

        .doc-content-render h1 {
            font-size: 1.5em;
            font-weight: 800;
            margin: 1.2em 0 0.6em;
            color: #1e293b;
        }

        .doc-content-render h2 {
            font-size: 1.3em;
            font-weight: 700;
            margin: 1em 0 0.5em;
            color: #1e293b;
        }

        .doc-content-render h3 {
            font-size: 1.1em;
            font-weight: 700;
            margin: 0.8em 0 0.4em;
        }

        .doc-content-render strong {
            color: #0f172a;
            font-weight: 700;
        }

        .doc-content-render table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.9em;
        }

        .doc-content-render th,
        .doc-content-render td {
            border: 1px solid #e2e8f0;
            padding: 0.5em;
            text-align: left;
        }

        .doc-content-render th {
            background-color: #f8fafc;
            font-weight: 600;
        }

        .doc-content-render ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .doc-content-render ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
    </style>
</head>

<body>

    <div id="app" class="max-w-md mx-auto h-screen flex flex-col bg-slate-50 relative overflow-hidden shadow-2xl">
        <!-- 椤舵爮 -->
        <nav-bar :active-tab="activeTab" @open-settings="showSettings = true"></nav-bar>

        <!-- 涓诲唴瀹瑰尯 -->
        <main class="flex-1 overflow-hidden relative">
            <transition name="fade" mode="out-in">
                <keep-alive>
                    <search-view v-if="activeTab === 'search'" key="search" @open-detail="openDetail"></search-view>
                    <library-view v-else-if="activeTab === 'library'" key="library"
                        @open-preview="openPreview"></library-view>
                    <extractor-view v-else-if="activeTab === 'extractor'" key="extractor"></extractor-view>
                </keep-alive>
            </transition>
        </main>

        <!-- 搴曟爮瀵艰埅 -->
        <tab-bar v-model="activeTab"></tab-bar>

        <!-- 璇︽儏寮圭獥 -->
        <detail-modal v-model="showDetail" :item="detailItem" :search-keyword="currentSearchKeyword"></detail-modal>

        <!-- 璁剧疆寮圭獥 -->
        <settings-modal v-model="showSettings"></settings-modal>

        <!-- 鍏ㄥ眬 Toast -->
        <toast-message></toast-message>

        <!-- 鍏ㄥ眬纭寮圭獥 -->
        <confirm-modal></confirm-modal>
    </div>

    <!-- 闅愯棌鐨?HTML 瑙ｆ瀽杈呭姪灞?(鍙€夛紝鐩墠 logic 宸茬Щ闄?docx-preview) -->
    <div id="html-parser-temp" class="hidden"></div>


    <!-- ========================================== -->
    <!--缁勪欢妯℃澘瀹氫箟 (Templates)-->
    <!-- ========================================== -->

    <!-- 1. 椤堕儴瀵艰埅缁勪欢妯℃澘 -->
    <script type="text/x-template" id="tmpl-nav-bar">
        <header class="h-14 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-4 sticky top-0 z-20">
            <h1 class="text-lg font-bold text-slate-800 tracking-tight flex items-center gap-2">
                <i class="ph-fill ph-read-cv-logo text-indigo-600 text-xl"></i>
                鏂囨。鏅烘悳 <span class="text-xs bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded-md font-medium">Pro</span>
            </h1>
            <button @click="$emit('open-settings')" class="p-2 text-slate-500 hover:text-indigo-600 hover:bg-slate-100 rounded-full transition-colors">
                <i class="ph ph-gear text-xl"></i>
            </button>
        </header>
    </script>

    <!-- 2. 鎼滅储瑙嗗浘妯℃澘 -->
    <script type="text/x-template" id="tmpl-search-view">
        <div class="h-full flex flex-col">
            <!-- 鎼滅储妗嗗尯鍩?-->
            <div class="p-4 bg-white shadow-sm z-10">
                <!-- 鎼滅储妗?-->
                <div class="relative">
                    <!-- 宸︿晶锛氭枃妗ｉ厤缃寜閽?-->
                    <button 
                        @click="showDocFilter = true"
                        class="absolute inset-y-0 left-0 pl-3.5 flex items-center z-10 transition-colors"
                        :class="isDocFilterActive ? 'text-indigo-600' : 'text-slate-400 hover:text-indigo-500'"
                        title="閰嶇疆鎼滅储鏂囨。"
                    >
                        <i class="ph-bold ph-funnel text-lg" :class="isDocFilterActive ? 'ph-fill' : ''"></i>
                    </button>
                    
                    <input 
                        ref="searchInput"
                        v-model="query"
                        @keydown.enter="handleSearch"
                        type="text" 
                        class="block w-full pl-11 pr-24 py-3 bg-slate-100 border-transparent text-slate-900 placeholder-slate-400 rounded-xl focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 focus:outline-none transition-all text-sm font-medium" 
                        placeholder="杈撳叆鍏抽敭瀛?(濡? 椤?..绠?..鐞?"
                    >
                    
                    <!-- 鍙充晶锛氱簿纭悳绱㈠垏鎹?+ 娓呴櫎鎸夐挳 -->
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center gap-1">
                        <button 
                            @click="toggleExactSearch"
                            class="p-1.5 rounded-lg transition-all"
                            :class="isExactSearch 
                                ? 'text-indigo-600' 
                                : 'text-slate-400 hover:text-indigo-500'"
                            :title="isExactSearch ? '绮剧‘鎼滅储锛氬紑鍚? : '绮剧‘鎼滅储锛氬叧闂?"
                        >
                            <i class="ph-bold ph-crosshair text-lg" :class="isExactSearch ? 'ph-fill' : ''"></i>
                        </button>
                        <button 
                            v-if="query" 
                            @click="clear" 
                            class="p-1.5 text-slate-400 hover:text-red-500 transition-colors"
                        >
                            <i class="ph-fill ph-x-circle text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 缁撴灉鍒楄〃 -->
            <div class="flex-1 overflow-y-auto p-4 scrollbar-hide space-y-4 pb-20">
                <!-- Loading -->
                <div v-if="isSearching" class="flex flex-col items-center justify-center py-12 space-y-3">
                    <i class="ph ph-spinner animate-spin text-3xl text-indigo-500"></i>
                    <p class="text-sm text-slate-400">鏅鸿兘鎵弿鎺掑簭涓?..</p>
                </div>

                <!-- 绌虹姸鎬?-->
                <div v-else-if="hasSearched && results.length === 0" class="flex flex-col items-center justify-center py-12 text-slate-400">
                    <i class="ph ph-files text-4xl mb-2 opacity-50"></i>
                    <p class="text-sm">鏈壘鍒扮鍚堥棿闅旀潯浠剁殑鍐呭</p>
                </div>

                <!-- 缁撴灉鍗＄墖 -->
                <div 
                    v-for="item in results" 
                    :key="item.id + '-' + item.matchIndex"
                    @click="$emit('open-detail', { ...item, keyword: query })"
                    class="bg-white rounded-xl p-4 border border-slate-100 shadow-sm active:scale-[0.99] active:bg-slate-50 transition-all cursor-pointer"
                >
                    <div class="flex items-center gap-2 mb-2">
                        <i class="ph-fill ph-file-text text-indigo-500 text-lg"></i>
                        <h3 class="font-bold text-slate-700 text-sm truncate flex-1">{{ item.fileName }}</h3>
                        <!-- 鏄剧ず闂撮殧绱у瘑搴﹁瘎鍒?-->
                        <span class="text-[10px] text-indigo-400 bg-indigo-50 px-1.5 py-0.5 rounded">
                           璺ㄥ害 {{ item.matchLength }} 瀛?                        </span>
                    </div>
                    
                    <!-- 棰勮鐗囨锛屽簲鐢ㄥ姩鎬佸瓧浣撳ぇ灏?-->
                    <div 
                        class="text-slate-600 leading-relaxed whitespace-pre-wrap break-words bg-slate-50/50 p-3 rounded-lg border border-slate-50 transition-all"
                        :style="{ fontSize: currentFontSize + 'px', lineHeight: '1.6' }"
                    >
                         <span v-html="item.highlightedSnippet"></span>
                    </div>
                    
                    <div class="mt-2 flex justify-between items-center text-xs text-slate-400">
                        <span>浣嶇疆: {{ item.matchIndex }}</span>
                        <span class="text-indigo-600 font-medium flex items-center gap-1">
                            鏌ョ湅璇︽儏 <i class="ph-bold ph-caret-right"></i>
                        </span>
                    </div>
                </div>

                <div v-if="results.length > 0" class="text-center py-2 text-xs text-slate-300">
                    - 宸叉樉绀?{{ results.length }} 鏉＄浉鍏崇粨鏋?(鎸夌揣瀵嗗害鎺掑簭) -
                </div>
            </div>

            <!-- 搴曢儴杈呭姪鏍?(鍒嗛〉 + 瀛椾綋婊戝潡 + 鍓垏鏉? -->
            <div class="px-3 py-2 border-t border-slate-100 flex items-center gap-2 bg-white/95 backdrop-blur-sm shrink-0 h-[52px]">
                  <!-- 鎻愬彇椤瑰垎椤垫帶鍒?-->
                  <div v-if="extractedList.length > 0" class="flex items-center bg-slate-100 rounded-xl border border-slate-200 flex-1 min-w-0 shadow-sm overflow-hidden">
                    <button @click="prevResult" class="w-8 h-9 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-white transition-all active:scale-90">
                        <i class="ph-bold ph-caret-left"></i>
                    </button>
                    
                    <!-- 涓嬫媺閫夋嫨瑙﹀彂鍣?(搴曢儴寮圭獥鏍峰紡) -->
                    <div @click="showSnippetDropdown = true" class="px-2 flex-1 min-w-0 h-9 flex items-center justify-center text-[10px] font-black text-indigo-600 cursor-pointer transition-colors group">
                        <span class="bg-indigo-600 text-white px-1.5 py-0.5 rounded-md mr-1.5 scale-90 shrink-0">{{ currentResultIndex + 1 }}</span>
                        <span class="truncate">{{ currentExtractedText || '---' }}</span>
                        <i class="ph-fill ph-caret-down ml-1 text-[8px] opacity-40 group-hover:opacity-100 transition-opacity"></i>
                    </div>

                    <!-- 閲嶆柊搴旂敤鎸夐挳 -->
                    <button @click="applyResult" class="w-8 h-9 flex items-center justify-center text-indigo-600 transition-all active:scale-90" title="閲嶆柊搴旂敤褰撳墠閫変腑鍐呭">
                        <i class="ph-bold ph-arrows-clockwise"></i>
                    </button>

                    <button @click="nextResult" class="w-8 h-9 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-white transition-all active:scale-90">
                        <i class="ph-bold ph-caret-right"></i>
                    </button>
                </div>

                 <!-- 瀛椾綋鎺у埗 -->
                 <div class="flex items-center gap-2 flex-1 min-w-0 bg-slate-50 px-3 h-9 rounded-xl border border-slate-100">
                    <i class="ph ph-text-t text-slate-400 text-xs"></i>
                    <input 
                        type="range" 
                        v-model.number="currentFontSize" 
                        :min="config.minFontSize" 
                        :max="config.maxFontSize" 
                        class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                    >
                    <i class="ph ph-text-t text-slate-600 text-lg"></i>
                </div>

                <!-- 鍓垏鏉挎爣绛?(褰撴湁鍐呭鏃舵樉绀? -->
                <transition name="fade">
                    <button 
                        v-if="clipboardText && clipboardText !== query"
                        @click="pasteClipboard"
                        class="flex items-center gap-1.5 px-3 h-9 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-xl text-xs font-bold transition-all active:scale-95 border border-indigo-100 shrink-0"
                    >
                        <i class="ph-bold ph-clipboard-text"></i>
                        <span class="truncate block max-w-[80px]">{{ clipboardText }}</span>
                    </button>
                </transition>
            </div>

            <!-- 鏂囨。绛涢€夐厤缃脊绐?-->
            <transition name="fade">
                <div v-if="showDocFilter" class="fixed inset-0 z-50 flex items-end justify-center" @click.self="showDocFilter = false">
                    <div class="bg-white w-full max-w-md rounded-t-3xl shadow-2xl overflow-hidden" @click.stop>
                        <!-- 鏍囬鏍?-->
                        <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100 bg-gradient-to-r from-indigo-50 to-white">
                            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <i class="ph-fill ph-funnel text-indigo-600"></i>
                                閰嶇疆鎼滅储鏂囨。
                            </h3>
                            <button @click="showDocFilter = false" class="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                                <i class="ph-bold ph-x text-xl"></i>
                            </button>
                        </div>

                        <!-- 宸ュ叿鏍?-->
                        <div class="flex items-center justify-between px-5 py-3 bg-slate-50 border-b border-slate-100">
                            <div class="flex items-center gap-2">
                                <button 
                                    @click="selectAllDocs"
                                    class="px-3 py-1.5 text-xs font-bold text-indigo-600 bg-white hover:bg-indigo-50 rounded-lg border border-indigo-100 transition-all active:scale-95"
                                >
                                    <i class="ph-bold ph-check-square"></i> 鍏ㄩ€?                                </button>
                                <button 
                                    @click="invertDocSelection"
                                    class="px-3 py-1.5 text-xs font-bold text-slate-600 bg-white hover:bg-slate-100 rounded-lg border border-slate-200 transition-all active:scale-95"
                                >
                                    <i class="ph-bold ph-arrows-left-right"></i> 鍙嶉€?                                </button>
                                <button 
                                    @click="clearAllDocs"
                                    class="px-3 py-1.5 text-xs font-bold text-slate-500 bg-white hover:bg-slate-100 rounded-lg border border-slate-200 transition-all active:scale-95"
                                >
                                    <i class="ph-bold ph-x-square"></i> 娓呯┖
                                </button>
                            </div>
                            <div class="text-xs text-slate-500 font-medium">
                                宸查€?<span class="text-indigo-600 font-bold">{{ selectedDocIds.size }}</span> / {{ allDocs.length }}
                            </div>
                        </div>

                        <!-- 鏂囨。鍒楄〃 -->
                        <div class="max-h-[60vh] overflow-y-auto custom-scrollbar px-5 py-3 space-y-2">
                            <div v-if="allDocs.length === 0" class="text-center py-10 text-slate-400">
                                <i class="ph ph-files text-4xl mb-2 opacity-50"></i>
                                <p class="text-sm">鏆傛棤鏂囨。</p>
                            </div>
                            <label 
                                v-for="doc in allDocs" 
                                :key="doc.id"
                                class="flex items-center gap-3 p-3 bg-white hover:bg-indigo-50 rounded-xl border border-slate-100 cursor-pointer transition-all group"
                                :class="selectedDocIds.has(doc.id) ? 'border-indigo-200 bg-indigo-50/50' : ''"
                            >
                                <input 
                                    type="checkbox" 
                                    :checked="selectedDocIds.has(doc.id)"
                                    @change="toggleDocSelection(doc.id)"
                                    class="w-5 h-5 text-indigo-600 border-slate-300 rounded focus:ring-2 focus:ring-indigo-200 cursor-pointer"
                                >
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <i class="ph-fill ph-file-text text-indigo-500 text-sm"></i>
                                        <h4 class="font-bold text-sm text-slate-700 truncate">{{ doc.fileName }}</h4>
                                    </div>
                                    <p class="text-xs text-slate-400">{{ (doc.content.length / 1000).toFixed(1) }}k 瀛?/p>
                                </div>
                            </label>
                        </div>

                        <!-- 搴曢儴鎸夐挳 -->
                        <div class="px-5 py-4 border-t border-slate-100 flex gap-3">
                            <button 
                                @click="showDocFilter = false"
                                class="flex-1 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-all"
                            >
                                鍙栨秷
                            </button>
                            <button 
                                @click="applyDocFilter"
                                class="flex-1 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100"
                            >
                                搴旂敤绛涢€?                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- 鎻愬彇椤归€夋嫨寮圭獥 (鏁堟灉鍙傝€冩悳绱㈡爮杩囨护) -->
            <transition name="fade">
                <div v-if="showSnippetDropdown" class="fixed inset-0 z-[60] flex items-end justify-center" @click.self="showSnippetDropdown = false">
                    <div class="bg-white w-full max-w-md rounded-t-3xl shadow-2xl overflow-hidden" @click.stop>
                        <!-- 鏍囬鏍?-->
                        <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100 bg-gradient-to-r from-indigo-50 to-white">
                            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <i class="ph-fill ph-selection-plus text-indigo-600"></i>
                                閫夋嫨鎻愬彇椤?                            </h3>
                            <button @click="showSnippetDropdown = false" class="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                                <i class="ph-bold ph-x text-xl"></i>
                            </button>
                        </div>

                        <!-- 鍒楄〃鍐呭 -->
                        <div class="max-h-[60vh] overflow-y-auto custom-scrollbar p-3 space-y-1">
                            <div 
                                v-for="(item, idx) in extractedList" 
                                :key="idx"
                                @click="currentResultIndex = idx; applyResult(); showSnippetDropdown = false"
                                class="flex items-center gap-2 p-2 rounded-xl border transition-all cursor-pointer group"
                                :class="currentResultIndex === idx ? 'bg-indigo-50 border-indigo-200 shadow-sm' : 'bg-white border-transparent hover:bg-slate-50'"
                            >
                                <div class="w-5 h-5 rounded-lg flex items-center justify-center text-xs font-bold shrink-0 transition-colors"
                                     :class="currentResultIndex === idx ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-400 group-hover:bg-slate-200'">
                                    {{ idx + 1 }}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-bold truncate transition-colors"
                                       :class="currentResultIndex === idx ? 'text-indigo-700' : 'text-slate-700'">
                                        {{ item.text }}
                                    </p>
                                </div>
                                <i v-if="currentResultIndex === idx" class="ph-bold ph-check text-indigo-600"></i>
                            </div>
                        </div>

                        <!-- 搴曢儴纭 -->
                        <div class="px-5 py-4 border-t border-slate-100">
                            <button 
                                @click="showSnippetDropdown = false"
                                class="w-full py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-all active:scale-[0.98]"
                            >
                                鍏抽棴
                            </button>
                        </div>
                    </div>
                </div>
            </transition>
        </div>
    </script>

    <!-- 3. 鏂囦欢搴撹鍥炬ā鏉?-->
    <script type="text/x-template" id="tmpl-library-view">
        <div class="h-full flex flex-col p-4">
            <!-- 涓婁紶鍖哄煙 -->
            <div class="mb-6">
                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-200 border-dashed rounded-2xl cursor-pointer bg-slate-50 hover:bg-indigo-50 hover:border-indigo-300 transition-colors group">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <div class="w-10 h-10 mb-2 rounded-full bg-indigo-100 flex items-center justify-center group-hover:bg-indigo-200 transition-colors">
                            <i class="ph-bold ph-upload-simple text-indigo-600 text-xl"></i>
                        </div>
                        <p class="mb-1 text-sm font-semibold text-slate-700">鐐瑰嚮涓婁紶鏂囨。</p>
                        <p class="text-xs text-slate-400">鏀寔 PDF, DOCX, TXT</p>
                    </div>
                    <input type="file" class="hidden" multiple accept=".pdf,.docx,.txt" @change="onFileSelect" />
                </label>
            </div>

            <!-- 鏂囦欢鍒楄〃 -->
            <div class="flex items-center justify-between mb-3 px-1">
                <h3 class="font-bold text-slate-700 text-sm">宸插瓨鍌ㄦ枃妗?({{ files.length }})</h3>
                <button @click="refresh" class="text-xs text-indigo-600 font-medium hover:underline">鍒锋柊</button>
            </div>

            <div class="flex-1 overflow-y-auto scrollbar-hide space-y-3 pb-20">
                <div v-if="loading" class="space-y-3">
                    <!-- Skeleton -->
                    <div v-for="i in 3" class="h-16 bg-slate-200 rounded-xl animate-pulse"></div>
                </div>

                <div v-else-if="files.length === 0" class="text-center py-10 text-slate-400">
                    <p class="text-sm">鏆傛棤鏂囨。锛岃涓婁紶</p>
                </div>

                <div 
                    v-for="file in files" 
                    :key="file.id"
                    class="group bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between transition-all active:bg-slate-50"
                >
                    <div class="flex items-center gap-3 flex-1 overflow-hidden" @click="$emit('open-preview', file)">
                        <div class="w-10 h-10 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600 shrink-0">
                            <i class="ph-fill ph-file-text text-xl"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-bold text-slate-700 truncate">{{ file.fileName }}</h4>
                            <p class="text-xs text-slate-400 mt-0.5">{{ formatDate(file.date) }} 路 {{ (file.content.length / 1000).toFixed(1) }}k 瀛?/p>
                        </div>
                    </div>
                    <button 
                        @click.stop="deleteFile(file.id)" 
                        class="p-2 text-slate-300 hover:text-red-500 transition-colors"
                    >
                        <i class="ph-bold ph-trash text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </script>

    <!-- 4. 閫夊瓧鎻愬彇瑙嗗浘妯℃澘 -->
    <script type="text/x-template" id="tmpl-extractor-view">
        <div class="h-full flex flex-col overflow-hidden">
            <!-- 姝ヨ繘鍒囨崲: 杈撳叆妯″紡 / 宸ヤ綔妯″紡 -->
            <div v-if="currentStep === 'input'" class="p-4 h-full flex flex-col space-y-2 overflow-y-auto scrollbar-hide">
                <div class="flex-1 flex flex-col gap-2">
                    <label class="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                        <i class="ph-fill ph-text-aa text-indigo-500"></i>
                        鍘熷鏂囨湰鍐呭
                    </label>
                    <textarea 
                        v-model="rawText" 
                        class="w-full flex-1 h-full p-4 border border-slate-200 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all resize-none bg-white shadow-inner text-sm leading-relaxed"
                        placeholder="鍦ㄦ澶勭矘璐存垨杈撳叆闇€瑕佸鐞嗙殑鏂囨湰..."
                    ></textarea>
                </div>
                <div class="flex gap-2">
                    <button 
                        @click="initSelection" 
                        :disabled="!rawText || !rawText.trim()"
                        class="flex-1 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-[0.98] shadow-lg shadow-indigo-100 flex items-center justify-center gap-2"
                    >
                        <i class="ph-bold ph-cursor-click"></i>
                        杩涘叆閫夊瓧妯″紡
                    </button>
                    <button 
                        @click="pasteFromClipboard" 
                        class="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-all active:scale-[0.98] flex items-center justify-center gap-2"
                        title="浠庡壀鍒囨澘鍐欏叆"
                    >
                        <i class="ph-bold ph-clipboard-text"></i>
                        绮樿创
                    </button>
                </div>
            </div>

            <div v-else class="h-full flex flex-col overflow-hidden">
                <!-- 鍐呴儴鍒嗘爮瀵艰埅 -->
                <div class="flex border-b border-slate-100 bg-white relative shrink-0">
                    <button @click="innerTab = 'select'" 
                            :class="['flex-1 py-3 text-sm font-bold transition-colors', innerTab === 'select' ? 'text-indigo-600' : 'text-slate-400']">
                        鏂囨湰閫夊瓧
                    </button>
                    <button @click="innerTab = 'list'" 
                            :class="['flex-1 py-3 text-sm font-bold transition-colors relative', innerTab === 'list' ? 'text-indigo-600' : 'text-slate-400']">
                        鎻愬彇缁撴灉
                        <span v-if="extractedList.length" class="ml-1.5 px-2 py-0.5 bg-indigo-50 text-indigo-600 rounded-full text-[10px] font-bold">
                            {{ extractedList.length }}
                        </span>
                    </button>
                    <!-- 婊戝姩鎸囩ず鍣?-->
                    <div class="absolute bottom-0 h-0.5 bg-indigo-600 transition-all duration-300 w-1/2"
                         :style="{ transform: `translateX(${innerTab === 'select' ? '0' : '100'}%)` }"></div>
                </div>

                <!-- 鍐呭鍖?-->
                <div class="flex-1 overflow-hidden relative">
                    <!-- 閫夊瓧闈㈡澘 -->
                    <div v-show="innerTab === 'select'" class="h-full overflow-y-auto p-2 bg-white scrollbar-hide" ref="gridContainer">
                        <!-- 浣跨敤 flex 甯冨眬淇濇寔鍘熸湁鎹㈣ -->
                        <div class="flex flex-wrap gap-1 content-start select-none pb-24"
                             @touchstart="onGridTouchStart"
                             @touchmove="onGridTouchMove"
                             @touchend="onGridTouchEnd">
                            <template v-for="(char, index) in charList" :key="index">
                                <!-- 鎹㈣绗﹀鐞?-->
                                <div v-if="char === '\n'" class="w-full h-0"></div>
                                <!-- 鏅€氬瓧绗?-->
                                <div v-else
                                     v-show="!hideSpaces || char.trim() !== ''"
                                     :data-index="index"
                                     :class="[
                                        'relative flex items-center justify-center rounded-[3px] font-medium text-sm transition-all border cursor-pointer',
                                        char === ' ' ? 'w-3' : '',
                                        selectedIndices.has(index) 
                                            ? 'bg-indigo-600 border-indigo-600 text-white z-10 scale-105 shadow-sm' 
                                            : getExtractedItemIndex(index) !== -1
                                                ? 'border-slate-200 z-[5]'
                                                : 'bg-slate-50 border-slate-100/80 text-slate-600'
                                     ]"
                                     :style="[
                                        char !== ' ' ? { width: config.charGridWidth + 'px', height: config.charGridWidth + 'px' } : {},
                                        !selectedIndices.has(index) && getExtractedItemIndex(index) !== -1 ? getExtractedStyle(index) : {}
                                     ]">
                                    {{ char }}
                                    <!-- 宸叉彁鍙栭」鐨勫簭鍙锋爣娉紙甯﹂€忔槑搴︼級 -->
                                    <span v-if="!selectedIndices.has(index) && getExtractedItemIndex(index) !== -1 && char !== ' '" 
                                          class="absolute -top-1.5 -right-1.5 w-4 h-4 rounded-full text-[9px] font-black flex items-center justify-center shadow-sm"
                                          :style="{ backgroundColor: getExtractedColor(getExtractedItemIndex(index)), color: 'white' }">
                                        {{ extractedList.length - getExtractedItemIndex(index) }}
                                    </span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- 缁撴灉闈㈡澘 -->
                    <div v-show="innerTab === 'list'" class="h-full overflow-y-auto p-4 space-y-3 bg-slate-50/50 scrollbar-hide pb-20">
                        <div v-if="extractedList.length === 0" class="flex flex-col items-center justify-center h-full text-slate-400 opacity-60">
                            <i class="ph ph-selection-plus text-5xl mb-3"></i>
                            <p class="text-sm">灏氭湭鎻愬彇浠讳綍鏂囧瓧</p>
                        </div>
                        <div v-for="(item, idx) in extractedList" 
                             :key="idx"
                             class="flex items-center justify-between p-4 bg-white rounded-xl border border-slate-100 shadow-sm group">
                            <div @click="editItem(idx)" class="flex-1 cursor-pointer">
                                <span class="text-[10px] text-indigo-500 font-bold uppercase tracking-wider mb-1 block">椤圭洰 #{{ extractedList.length - idx }}</span>
                                <p class="text-slate-800 font-semibold leading-relaxed whitespace-pre-wrap">{{ item.text }}</p>
                            </div>
                            <div class="flex items-center gap-1">
                                <button @click="copyItem(item.text)" class="p-2 text-slate-300 hover:text-indigo-500 transition-colors">
                                    <i class="ph-bold ph-copy text-lg"></i>
                                </button>
                                <button @click="removeItem(idx)" class="p-2 text-slate-300 hover:text-red-500 transition-colors">
                                    <i class="ph-bold ph-trash text-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 鎮诞鎿嶄綔鎸夐挳宸茬Щ闄わ紝绉诲姩鑷冲簳閮ㄨ緟鍔╂爮 -->
                </div>

                <!-- 搴曢儴杈呭姪鏍?(澧炲己鐗?- 绮剧畝 UI) -->
                <div class="px-4 py-2 border-t border-slate-100 flex items-center justify-between bg-white/95 backdrop-blur-sm shrink-0 h-[52px]">
                    <button @click="currentStep = 'input'" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-slate-100 rounded-lg transition-colors" title="閲嶈鍘熸枃">
                        <i class="ph ph-arrow-left text-lg"></i>
                    </button>
                    
                    <div v-if="innerTab === 'select'" class="flex items-center gap-0.5 bg-slate-100/50 p-0.5 rounded-xl border border-slate-100">
                        <button @click="hideSpaces = !hideSpaces" 
                                :class="['w-8 h-8 flex items-center justify-center rounded-lg transition-all', hideSpaces ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600']"
                                title="鍒囨崲闅愯棌绌烘牸">
                            <i :class="hideSpaces ? 'ph-fill ph-ghost' : 'ph-bold ph-selection' " class="text-lg"></i>
                        </button>
                        <div class="w-px h-4 bg-slate-200 mx-0.5"></div>
                        <button @click="clearSymbols" class="w-8 h-8 flex items-center justify-center text-slate-400 active:text-indigo-600 active:bg-slate-200 rounded-lg transition-all" title="蹇€熸竻闄ょ鍙?>
                            <i class="ph ph-broom text-lg"></i>
                        </button>
                        <button @click="selectAll" class="w-8 h-8 flex items-center justify-center text-slate-400 active:text-indigo-600 active:bg-slate-200 rounded-lg transition-all" title="鍏ㄩ€?>
                            <i class="ph ph-check-square text-lg"></i>
                        </button>
                        <button @click="invertSelection" class="w-8 h-8 flex items-center justify-center text-slate-400 active:text-indigo-600 active:bg-slate-200 rounded-lg transition-all" title="鍙嶉€?>
                            <i class="ph ph-arrows-left-right text-lg"></i>
                        </button>
                        <button @click="selectedIndices.clear()" class="w-8 h-8 flex items-center justify-center text-slate-400 active:text-red-500 active:bg-red-50 rounded-lg transition-all" title="娓呯┖閫夋嫨">
                            <i class="ph ph-trash-simple text-lg"></i>
                        </button>
                    </div>

                    <div class="flex items-center gap-2">
                        <button v-if="innerTab === 'select'" 
                                @click="handleAction" 
                                :disabled="selectedIndices.size === 0"
                                class="h-9 px-3 flex items-center gap-1.5 bg-indigo-600 text-white rounded-xl shadow-md shadow-indigo-100 active:scale-95 disabled:opacity-30 disabled:grayscale disabled:shadow-none transition-all"
                                :title="editingIndex === -1 ? '淇濆瓨鎻愬彇' : '鏇存柊椤圭洰'">
                            <i class="ph-fill ph-check-circle text-lg"></i>
                            <span class="text-xs font-bold leading-none">{{ editingIndex === -1 ? '鎻愬彇' : '鏇存柊' }}</span>
                        </button>
                        <button v-if="innerTab === 'list' && extractedList.length > 0" 
                                @click="clearAllResults" 
                                class="w-9 h-9 flex items-center justify-center text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all active:scale-90 border border-transparent hover:border-red-100" 
                                title="娓呯┖鎵€鏈夌粨鏋?>
                            <i class="ph-bold ph-trash text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <!-- 5. 璇︽儏寮圭獥妯℃澘 -->
    <script type="text/x-template" id="tmpl-detail-modal">
        <transition name="slide-up">
            <div v-if="modelValue" class="absolute inset-0 z-50 flex flex-col bg-white">
                <!-- Header -->
                <div class="h-14 px-4 border-b border-slate-100 flex items-center justify-between bg-white/90 backdrop-blur z-10 basis-14 shrink-0 grow-0">
                    <button @click="close" class="p-2 -ml-2 text-slate-500 hover:text-slate-800">
                        <i class="ph-bold ph-caret-down text-xl"></i>
                    </button>
                    <h2 class="text-sm font-bold text-slate-800 truncate flex-1 min-w-0 mr-2">{{ item?.fileName }}</h2>
                    <div class="flex items-center gap-1 shrink-0">
                        <!-- 瀛椾綋婊戝潡 -->
                        <div class="h-8 flex items-center gap-1.5 bg-slate-50 px-2 rounded-full border border-slate-100 mr-1">
                            <i class="ph ph-text-aa text-slate-400 text-sm"></i>
                            <input 
                                type="range" 
                                v-model.number="currentFontSize"
                                :min="config.minFontSize" 
                                :max="config.maxFontSize"  
                                class="w-16 h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer range-sm"
                            >
                            <i class="ph ph-text-aa text-slate-400 text-lg"></i>
                        </div>
                        <!-- 妯″紡鍒囨崲鎸夐挳 -->
                        <button 
                            @click="toggleMode"
                            class="h-8 px-3 flex items-center gap-1.5 bg-slate-50 text-slate-500 rounded-full border border-slate-100 transition-all hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-100"
                            :class="isFullMode ? 'bg-indigo-50 text-indigo-600 border-indigo-100' : ''"
                            :title="isFullMode ? '褰撳墠涓哄叏鏂囨ā寮忥紝鐐瑰嚮鍒囨崲鍒扮墖娈垫ā寮? : '褰撳墠涓虹墖娈垫ā寮忥紝鐐瑰嚮鍒囨崲鍒板叏鏂囨ā寮?"
                        >
                            <i :class="isFullMode ? 'ph-fill ph-book-open' : 'ph-fill ph-scissors'"></i>
                            {{ isFullMode ? '鍏ㄦ枃' : '鐗囨' }}
                        </button>
                    </div>
                    <!-- 鏍锋澘鍒囨崲鎸夐挳 (鍏ㄦā寮?鐗囨妯″紡閫氱敤) -->
                    <div class="ml-1">
                        <button 
                            @click="toggleOriginal"
                            class="h-8 w-8 flex items-center justify-center rounded-full transition-all border border-transparent"
                            :class="showOriginal ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 hover:border-indigo-100'"
                            :title="showOriginal ? '鏄剧ず绾噣鏂囨湰(鏀寔楂樹寒)' : '鏄剧ず鍘熺増鏍峰紡(鑳屾櫙/棰滆壊)'"
                        >
                            <i :class="showOriginal ? 'ph-fill ph-paint-brush-broad' : 'ph-bold ph-paint-brush-broad'" class="text-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div class="flex-1 p-5 pr-1 relative bg-white overflow-hidden" ref="contentContainer">
                   <div class="w-full h-full pr-4 overflow-y-auto custom-scrollbar" ref="scrollContainer">
                        <div v-if="loading" class="flex justify-center py-10">
                            <i class="ph ph-spinner animate-spin text-2xl text-indigo-500"></i>
                        </div>
                        
                        <div v-else 
                            class="doc-content-render max-w-none text-slate-700 leading-8 whitespace-pre-wrap break-words font-sans transition-all"
                            :style="{ fontSize: currentFontSize + 'px', lineHeight: '1.6' }">
                            
                            <!-- 鏍稿績娓叉煋鍖哄煙 -->
                            <div v-html="displayContent"></div>
                        </div>

                        <div class="h-40"></div>
                   </div>
                </div>
            </div>
        </transition>
        <!-- 閬僵 -->
        <transition name="fade">
            <div v-if="modelValue" class="absolute inset-0 bg-black/20 z-40 backdrop-blur-sm" @click="close"></div>
        </transition>
    </script>

    <!-- 5. 搴曢儴 TabBar 妯℃澘 -->
    <script type="text/x-template" id="tmpl-tab-bar">
        <div class="h-[60px] bg-white border-t border-slate-200 flex justify-around items-center px-2 z-30 pb-safe">
            <button 
                class="flex-1 flex flex-col items-center justify-center h-full gap-1 active:scale-95 transition-transform"
                :class="modelValue === 'search' ? 'text-indigo-600' : 'text-slate-400'"
                @click="$emit('update:modelValue', 'search')"
            >
                <i :class="modelValue === 'search' ? 'ph-fill ph-magnifying-glass' : 'ph-bold ph-magnifying-glass'" class="text-2xl"></i>
                <span class="text-[10px] font-medium">鏅鸿兘鎼滅储</span>
            </button>
            <button 
                class="flex-1 flex flex-col items-center justify-center h-full gap-1 active:scale-95 transition-transform"
                :class="modelValue === 'library' ? 'text-indigo-600' : 'text-slate-400'"
                @click="$emit('update:modelValue', 'library')"
            >
                <i :class="modelValue === 'library' ? 'ph-fill ph-books' : 'ph-bold ph-books'" class="text-2xl"></i>
                <span class="text-[10px] font-medium">鏂囨。搴?/span>
            </button>
            <button 
                class="flex-1 flex flex-col items-center justify-center h-full gap-1 active:scale-95 transition-transform"
                :class="modelValue === 'extractor' ? 'text-indigo-600' : 'text-slate-400'"
                @click="$emit('update:modelValue', 'extractor')"
            >
                <i :class="modelValue === 'extractor' ? 'ph-fill ph-selection-plus' : 'ph-bold ph-selection-plus'" class="text-2xl"></i>
                <span class="text-[10px] font-medium">閫夊瓧鎻愬彇</span>
            </button>
        </div>
    </script>

    <!-- ========================================== -->
    <!-- 閫昏緫浠ｇ爜 (Vue + Hooks) -->
    <!-- ========================================== -->

    <script>
        const { createApp, ref, reactive, computed, watch, onMounted, onActivated, nextTick, toRef } = Vue;
        const { useDebounceFn, useStorage, useClipboard } = VueUse;

        // --- 鍏ㄥ眬閰嶇疆 (浣跨敤 useStorage 瀹炵幇鍝嶅簲寮忔寔涔呭寲) ---
        const globalConfig = useStorage('doc_search_config', {
            previewRange: 30,    // 鎼滅储缁撴灉棰勮鐨勪笂涓嬫枃闀垮害
            minFontSize: 12,     // 鏂囨湰闃呰鍣ㄧ殑鏈€灏忓瓧鍙?            maxFontSize: 36,     // 鏂囨湰闃呰鍣ㄧ殑鏈€澶у瓧鍙?            maxSearchGap: 30,    // 鎼滅储鍏抽敭璇嶅悎骞剁殑鏈€澶у瓧绗﹂棿闅?            detailRange: 200,    // 璇︽儏妯″紡涓嬬殑涓婁笅鏂囬瑙堣寖鍥?            charGridWidth: 26    // 閫夊瓧鎻愬彇鐣岄潰鐨勫瓧绗︾綉鏍煎搴?        });

        // --- Shared Defaults ---
        const extractorDefaultState = {
            currentStep: 'input',
            innerTab: 'select',
            rawText: '',
            extractedList: [],
            selectedIndices: [],
            hideSpaces: false
        };

        // --- 鍏ㄥ眬鐘舵€佺鐞?Toast ---
        const toastState = reactive({ show: false, message: '', type: 'success' });
        const showToast = (msg, type = 'success') => {
            toastState.message = msg;
            toastState.type = type;
            toastState.show = true;
            setTimeout(() => toastState.show = false, 2000);
        };
        const ToastMessage = {
            setup() { return { toastState } },
            template: `
                <transition name="fade">
                    <div v-if="toastState.show" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[100] bg-slate-800/90 backdrop-blur text-white px-4 py-3 rounded-xl shadow-xl text-sm font-medium flex items-center gap-2 max-w-[80%] text-center">
                        <i v-if="toastState.type === 'success'" class="ph-fill ph-check-circle text-green-400 text-lg"></i>
                        <i v-else class="ph-fill ph-warning-circle text-red-400 text-lg"></i>
                        {{ toastState.message }}
                    </div>
                </transition>
            `
        };

        // --- 鍏ㄥ眬纭寮圭獥缁勪欢 ---
        const confirmState = reactive({
            show: false,
            title: '',
            message: '',
            confirmText: '纭',
            cancelText: '鍙栨秷',
            type: 'info',
            resolve: null
        });

        const showConfirm = (opts) => {
            confirmState.title = opts.title || '纭鎻愮ず';
            confirmState.message = opts.message || '';
            confirmState.confirmText = opts.confirmText || '纭';
            confirmState.cancelText = opts.cancelText || '鍙栨秷';
            confirmState.type = opts.type || 'info';
            confirmState.show = true;
            return new Promise((resolve) => {
                confirmState.resolve = resolve;
            });
        };

        const ConfirmModal = {
            setup() {
                const handleCancel = () => {
                    confirmState.show = false;
                    if (confirmState.resolve) confirmState.resolve(false);
                };
                const handleConfirm = () => {
                    confirmState.show = false;
                    if (confirmState.resolve) confirmState.resolve(true);
                };
                return { confirmState, handleCancel, handleConfirm };
            },
            template: `
                <transition name="fade">
                    <div v-if="confirmState.show" class="fixed inset-0 z-[200] flex items-center justify-center p-4">
                        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="handleCancel"></div>
                        <div class="bg-white rounded-[2rem] w-full max-w-[320px] overflow-hidden relative shadow-2xl z-20 transform transition-all">
                            <div class="p-8 text-center">
                                <div :class="[
                                    'w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-5 rotate-3 shadow-inner transition-colors',
                                    confirmState.type === 'danger' ? 'bg-red-50 text-red-500' : 'bg-indigo-50 text-indigo-600'
                                ]">
                                    <i :class="[
                                        'ph-fill text-3xl',
                                        confirmState.type === 'danger' ? 'ph-warning-circle' : 'ph-question'
                                    ]"></i>
                                </div>
                                <h3 class="text-xl font-black text-slate-800 mb-2">{{ confirmState.title }}</h3>
                                <p class="text-sm text-slate-500 leading-relaxed">{{ confirmState.message }}</p>
                            </div>
                            <div class="flex p-4 gap-3 bg-slate-50/50">
                                <button @click="handleCancel" class="flex-1 py-3.5 text-sm font-bold text-slate-400 bg-white hover:bg-slate-100 rounded-2xl transition-all border border-slate-100 active:scale-95">
                                    {{ confirmState.cancelText }}
                                </button>
                                <button @click="handleConfirm" :class="[
                                    'flex-1 py-3.5 text-sm font-bold rounded-2xl transition-all shadow-lg active:scale-95 text-white',
                                    confirmState.type === 'danger' ? 'bg-red-500 shadow-red-200' : 'bg-indigo-600 shadow-indigo-200'
                                ]">
                                    {{ confirmState.confirmText }}
                                </button>
                            </div>
                        </div>
                    </div>
                </transition>
            `
        };

        // --- HOOK: 鏁版嵁搴?(Dexie) ---
        function useDB() {
            const db = new Dexie("LocalDocDB_Pro");
            db.version(3).stores({
                files: '++id, fileName, date' // content, htmlContent, rawBlob 涓嶅缓绱㈠紩
            });
            return db;
        }

        // --- HOOK: 鏂囦欢瑙ｆ瀽 ---
        function useParser() {
            // 瀹夊叏鍒濆鍖?PDF Worker
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }

            const parseFile = async (file) => {
                if (file.type === "application/pdf") {
                    if (typeof pdfjsLib === 'undefined') {
                        console.error("PDF.js library failed to load");
                        return { text: "Error: PDF Parser not loaded", html: null };
                    }
                    const ab = await file.arrayBuffer();

                    const pdf = await pdfjsLib.getDocument(ab).promise;
                    let textParts = [];
                    let lastY = -1;

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();

                        let pageText = "";
                        content.items.forEach(item => {
                            // 绠€鍗曠殑鎹㈣閫昏緫锛氬鏋?Y 鍧愭爣鍙樺寲杈冨ぇ锛岃涓烘槸鏂拌
                            if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > 5) {
                                pageText += "\n";
                            }
                            pageText += item.str;
                            lastY = item.transform[5];
                        });
                        textParts.push(pageText);
                    }
                    const fullText = textParts.join('\n\n---\n\n');
                    return { text: fullText, html: null }; // PDF 鏆備笉鎻愬彇 HTML

                } else if (file.name.endsWith(".docx")) {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const zip = await JSZip.loadAsync(arrayBuffer);
                        const docXml = await zip.file("word/document.xml").async("text");

                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(docXml, "text/xml");
                        const body = xmlDoc.getElementsByTagName("w:body")[0];

                        let fullHtml = "";
                        let fullText = "";

                        // --- 鏍峰紡鏄犲皠涓庤緟鍔╁嚱鏁?---
                        const highlightColorMap = {
                            yellow: "#FFFF00", green: "#00FF00", cyan: "#00FFFF",
                            magenta: "#FF00FF", blue: "#0000FF", red: "#FF0000",
                            darkBlue: "#00008B", darkCyan: "#008B8B", darkGreen: "#006400",
                            darkMagenta: "#8B008B", darkRed: "#8B0000", darkYellow: "#808000",
                            darkGray: "#A9A9A9", lightGray: "#D3D3D3", black: "#000000"
                        };

                        const escapeHTML = (str) => str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

                        // 瑙ｆ瀽 Run (w:r) -> HTML Span
                        const processRun = (r) => {
                            const tNode = r.getElementsByTagName("w:t")[0];
                            if (!tNode) return { text: "", html: "" };

                            const text = tNode.textContent;
                            const rPr = r.getElementsByTagName("w:rPr")[0];
                            let styles = [];

                            if (rPr) {
                                // 瀛椾綋棰滆壊
                                const colorNode = rPr.getElementsByTagName("w:color")[0];
                                if (colorNode) {
                                    const val = colorNode.getAttribute("w:val");
                                    if (val && val !== "auto") styles.push(`color: #${val}`);
                                }
                                // 鑳屾櫙楂樹寒
                                const highlightNode = rPr.getElementsByTagName("w:highlight")[0];
                                if (highlightNode) {
                                    const val = highlightNode.getAttribute("w:val");
                                    if (highlightColorMap[val]) styles.push(`background-color: ${highlightColorMap[val]}`);
                                }
                                // 鑳屾櫙搴曠汗
                                const shdNode = rPr.getElementsByTagName("w:shd")[0];
                                if (shdNode) {
                                    const fill = shdNode.getAttribute("w:fill");
                                    if (fill && fill !== "auto" && fill !== "clear") styles.push(`background-color: #${fill}`);
                                }
                                // 绮椾綋/鏂滀綋
                                if (rPr.getElementsByTagName("w:b").length > 0) styles.push("font-weight: bold");
                                if (rPr.getElementsByTagName("w:i").length > 0) styles.push("font-style: italic");
                                // 瀛楀彿
                                const szNode = rPr.getElementsByTagName("w:sz")[0];
                                if (szNode) {
                                    const size = parseInt(szNode.getAttribute("w:val"));
                                    if (!isNaN(size)) styles.push(`font-size: ${size / 2}pt`);
                                }
                            }

                            const span = styles.length > 0
                                ? `<span style="${styles.join('; ')}">${escapeHTML(text)}</span>`
                                : escapeHTML(text);
                            return { text, html: span };
                        };

                        // 瑙ｆ瀽娈佃惤 (w:p)
                        const processParagraph = (p) => {
                            let pHtml = "";
                            let pText = "";
                            let pStyles = [];

                            // 娈佃惤灞炴€? 瀵归綈/缂╄繘/鍒楄〃
                            const pPr = p.getElementsByTagName("w:pPr")[0];
                            if (pPr) {
                                // 瀵归綈
                                const jc = pPr.getElementsByTagName("w:jc")[0];
                                if (jc) {
                                    const val = jc.getAttribute("w:val");
                                    const alignMap = { center: 'center', right: 'right', both: 'justify' };
                                    if (alignMap[val]) pStyles.push(`text-align: ${alignMap[val]}`);
                                }
                                // 缂╄繘
                                const ind = pPr.getElementsByTagName("w:ind")[0];
                                if (ind) {
                                    const left = parseInt(ind.getAttribute("w:left"));
                                    if (!isNaN(left)) pStyles.push(`margin-left: ${left / 20}pt`);
                                    const firstLine = parseInt(ind.getAttribute("w:firstLine"));
                                    if (!isNaN(firstLine)) pStyles.push(`text-indent: ${firstLine / 20}pt`);
                                }
                                // 绠€鍗曞垪琛ㄦā鎷?(鍙鏈?numPr 灏卞綋鍋?list-item)
                                const numPr = pPr.getElementsByTagName("w:numPr")[0];
                                if (numPr) {
                                    pStyles.push("display: list-item");
                                    pStyles.push("list-style-type: disc"); // 榛樿鍦嗙偣锛屾棤娉曞噯纭幏鍙?numbering.xml
                                    pStyles.push("list-style-position: inside");
                                    if (!pStyles.some(s => s.startsWith('margin-left'))) {
                                        pStyles.push("margin-left: 1em");
                                    }
                                }
                            }

                            // 閬嶅巻娈佃惤鍐呮墍鏈夊瓙鑺傜偣锛堝寘鎷?w:r 鍜?w:br锛?                            const childNodes = p.childNodes;
                            for (let j = 0; j < childNodes.length; j++) {
                                const child = childNodes[j];
                                const nodeName = child.nodeName;

                                if (nodeName === "w:r") {
                                    // 澶勭悊 Run锛屼絾涔熻妫€鏌?Run 鍐呴儴鏄惁鏈?w:br
                                    const runChildren = child.childNodes;
                                    for (let k = 0; k < runChildren.length; k++) {
                                        const runChild = runChildren[k];
                                        if (runChild.nodeName === "w:t") {
                                            // 鏂囨湰鑺傜偣
                                            const { text, html } = processRun(child);
                                            pHtml += html;
                                            pText += text;
                                            break; // processRun 宸茬粡澶勭悊浜嗘暣涓?run
                                        } else if (runChild.nodeName === "w:br") {
                                            // Run 鍐呴儴鐨勬崲琛?                                            pHtml += '<br class="docx-br">';
                                            pText += "\n";
                                        }
                                    }
                                    // 妫€鏌ユ槸鍚﹀彧鏈?br 娌℃湁 t
                                    const hasBrOnly = child.getElementsByTagName("w:br").length > 0 &&
                                        child.getElementsByTagName("w:t").length === 0;
                                    if (hasBrOnly) {
                                        pHtml += '<br class="docx-br">';
                                        pText += "\n";
                                    }
                                }
                                else if (nodeName === "w:br") {
                                    // 娈佃惤绾у埆鐨勬崲琛岋紙涓嶅お甯歌锛屼絾浠ラ槻涓囦竴锛?                                    pHtml += '<br class="docx-br">';
                                    pText += "\n";
                                }
                                // 蹇界暐 w:pPr 绛夐潪鍐呭鑺傜偣
                            }

                            // 缁勮 P (寮哄埗鍧楃骇鏄剧ず锛岀‘淇濇崲琛?
                            const styleStr = pStyles.concat(
                                "display: block",
                                "min-height: 1.5em", // 澧炲姞鏈€灏忛珮搴?                                "margin-bottom: 0.8em", // 澧炲姞娈甸棿璺?                                "line-height: 1.6",
                                "word-wrap: break-word"
                            ).join("; ");

                            // 纭繚绌烘钀戒篃鏈夐珮搴?                            const innerContent = pHtml || '<br>';
                            return {
                                html: `<div class="docx-p" style="${styleStr}">${innerContent}</div>`,
                                text: pText + "\n" // 纭繚绾枃鏈湁鎹㈣
                            };
                        };

                        // 瑙ｆ瀽琛ㄦ牸 (w:tbl)
                        const processTable = (tbl) => {
                            let tblHtml = '<table style="border-collapse: collapse; width: 100%; margin: 1em 0; border: 1px solid #ddd;">';
                            let tblText = "";
                            const rows = tbl.getElementsByTagName("w:tr");

                            for (let i = 0; i < rows.length; i++) {
                                tblHtml += "<tr>";
                                const cells = rows[i].getElementsByTagName("w:tc");
                                for (let j = 0; j < cells.length; j++) {
                                    const tc = cells[j];
                                    let cellHtml = "";
                                    let cellText = "";

                                    // 鍗曞厓鏍煎唴鍙兘鍖呭惈澶氫釜娈佃惤锛岄€掑綊澶勭悊
                                    const cellParas = tc.getElementsByTagName("w:p");
                                    for (let k = 0; k < cellParas.length; k++) {
                                        const res = processParagraph(cellParas[k]);
                                        cellHtml += res.html;
                                        cellText += res.text;
                                    }

                                    tblHtml += `<td style="border: 1px solid #cbd5e1; padding: 8px;">${cellHtml}</td>`;
                                    tblText += cellText + " ";
                                }
                                tblHtml += "</tr>";
                                tblText += "\n";
                            }
                            tblHtml += "</table>";
                            return { html: tblHtml, text: tblText };
                        };

                        // 涓婚亶鍘嗗惊鐜?(鏀逛负鑾峰彇鎵€鏈夋钀界殑鎵佸钩鍒楄〃锛岀‘淇濅笉婕忔帀宓屽鍐呭)
                        // 娉ㄦ剰锛氫负浜嗕繚鎸佽〃鏍肩粨鏋勶紝鎴戜滑涓嶈兘绠€鍗曞湴 getElementsByTagName('w:p')锛?                        // 鍚﹀垯琛ㄦ牸閲岀殑 p 浼氳閲嶅澶勭悊鎴栬€呰劚绂昏〃鏍肩粨鏋勩€?
                        // 姝ｇ‘鍋氭硶锛氶€掑綊閬嶅巻 body 鐨勫瓙鑺傜偣锛岄亣鍒?Table 澶勭悊 Table锛岄亣鍒?P 澶勭悊 P銆?                        // 瀵逛簬宓屽鍦ㄥ叾浠栭潪 Table 瀹瑰櫒锛堝 sdt, textbox锛夐噷鐨?P锛岄€掑綊娣卞叆銆?
                        const traverseNodes = (node) => {
                            let htmlResult = "";
                            let textResult = "";

                            for (let i = 0; i < node.childNodes.length; i++) {
                                const child = node.childNodes[i];
                                const nodeName = child.nodeName;

                                if (nodeName === "w:p") {
                                    const res = processParagraph(child);
                                    htmlResult += res.html;
                                    textResult += res.text;
                                }
                                else if (nodeName === "w:tbl") {
                                    const res = processTable(child);
                                    htmlResult += res.html;
                                    textResult += res.text; // 琛ㄦ牸鍐呭涔熷姞鍏ョ函鏂囨湰
                                }
                                else if (nodeName === "w:sdt" || nodeName === "w:sdtContent" || nodeName === "w:txbxContent" || nodeName === "w:body") {
                                    // 瀹瑰櫒鑺傜偣锛岄€掑綊杩涘叆
                                    const res = traverseNodes(child);
                                    htmlResult += res.html;
                                    textResult += res.text;
                                }
                                else if (child.nodeType === 1) { // Element node
                                    // 鍏朵粬鏈煡鏍囩锛屽皾璇曢€掑綊瀵绘壘鍐呴儴鐨?P 鎴?Tbl
                                    // 浣嗚閬垮厤 w:pPr, w:rPr 杩欑灞炴€ц妭鐐?                                    if (!nodeName.endsWith("Pr")) {
                                        const res = traverseNodes(child);
                                        htmlResult += res.html;
                                        textResult += res.text;
                                    }
                                }
                            }
                            return { html: htmlResult, text: textResult };
                        };

                        if (body) {
                            const finalRes = traverseNodes(body);
                            fullHtml = finalRes.html;
                            fullText = finalRes.text;
                        }

                        // 鍏滃簳锛氬鏋滈€掑綊娌℃壘鍒颁换浣曞唴瀹癸紙鏋佺鎯呭喌锛夛紝灏濊瘯鏆村姏鑾峰彇鎵€鏈?w:p
                        if (!fullHtml) {
                            console.warn("Recursive traversal failed, falling back to flat p list");
                            const allParas = xmlDoc.getElementsByTagName("w:p");
                            for (let i = 0; i < allParas.length; i++) {
                                const res = processParagraph(allParas[i]);
                                fullHtml += res.html;
                                fullText += res.text;
                            }
                        }

                        return { text: fullText, html: fullHtml };

                    } catch (e) {
                        console.error("Docx parse error", e);

                        // 闄嶇骇澶勭悊
                        const text = await file.text();
                        return { text, html: `<pre>${text}</pre>` };
                    }
                } else {
                    const text = await file.text();
                    return { text, html: null };
                }
            };

            const escapeHTML = (str) => str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

            return { parseFile };
        }

        // --- HOOK: 鎼滅储涓庨珮浜紩鎿?(Core Logic Optimized) ---
        function useSearchEngine() {

            const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

            // 浼樺寲 1: 娣诲姞 maxGap 鍙傛暟锛岄檺鍒舵渶澶ч棿闅?            const createSearchRegex = (keyword, maxGap = 30) => {
                const chars = keyword.split('').filter(c => c.trim() !== '');
                if (chars.length === 0) return null;

                // 浣跨敤 {0,maxGap} 闄愬埗鍖归厤闀垮害锛岄伩鍏嶈法瓒婂お杩滐紝骞惰В鍐?鍓嶉潰鏈夎瘝瀵艰嚧涓嶈繛缁?鐨勯棶棰?                // 鎳掓儼鍖归厤 ? 纭繚鎵惧埌鏈€杩戠殑缁勫悎
                const gapPattern = `([\\s\\S]{0,${maxGap}}?)`;
                const pattern = chars.map(c => `(${escapeRegExp(c)})`).join(gapPattern);

                try {
                    return new RegExp(pattern, 'gi');
                } catch (e) {
                    console.error("Regex too complex", e);
                    return null;
                }
            };

            const escapeHTML = (str) => {
                if (!str) return '';
                return str.replace(/[&<>"']/g, m => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                }[m]));
            };

            const highlightText = (text, keyword, maxGap = 30) => {
                if (!text) return '';
                if (!keyword) return escapeHTML(text);
                const chars = keyword.split('').filter(c => c.trim() !== '');
                const regex = createSearchRegex(keyword, maxGap);
                if (!regex) return escapeHTML(text);

                let result = "";
                let lastIndex = 0;
                let match;
                regex.lastIndex = 0;

                while ((match = regex.exec(text)) !== null) {
                    // 娣诲姞鍖归厤椤逛箣鍓嶇殑鍘熸枃锛堣浆涔夛級
                    result += escapeHTML(text.substring(lastIndex, match.index));

                    // 澶勭悊鍖归厤椤癸細楂樹寒閮ㄥ垎杞箟鍚庡寘瑁?mark 鏍囩锛岀┖闅欓儴鍒嗕粎杞箟
                    let captureGroupIndex = 0;
                    for (let i = 0; i < chars.length; i++) {
                        const charPart = match[captureGroupIndex + 1];
                        result += `<mark class="highlight">${escapeHTML(charPart)}</mark>`;
                        captureGroupIndex++;

                        if (i < chars.length - 1) {
                            const gapPart = match[captureGroupIndex + 1];
                            result += escapeHTML(gapPart);
                            captureGroupIndex++;
                        }
                    }

                    lastIndex = regex.lastIndex;
                    // 闃叉姝诲惊鐜?                    if (match.index === regex.lastIndex) regex.lastIndex++;
                }

                // 娣诲姞鍓╀綑閮ㄥ垎
                result += escapeHTML(text.substring(lastIndex));
                return result;
            };

            // 鏂板锛氬熀浜?DOM Range 鐨勬櫤鑳?HTML 鐗囨鎴彇
            const getHtmlFragment = (html, keyword, maxGap = 30, limit = 200) => {
                if (!html) return '';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                // 1. 鍏堣繘琛岄珮浜鐞?                if (keyword) {
                    highlightHtmlElement(tempDiv, keyword, maxGap);
                }

                // 2. 濡傛灉涓嶉渶瑕佹埅鍙栵紙鍏ㄦ枃妯″紡浣跨敤0鎴朓nfinity琛ㄧず锛夛紝鐩存帴杩斿洖
                if (!limit || limit <= 0) return tempDiv.innerHTML;

                // 3. 瀵绘壘鎴彇涓績鐐?(绗竴涓?mark 鎴栧紑澶?
                let centerNode = null;
                let centerOffset = 0;
                const firstMark = tempDiv.querySelector('mark.highlight');

                if (firstMark && firstMark.firstChild) {
                    centerNode = firstMark.firstChild;
                    centerOffset = 0;
                } else {
                    // 娌℃湁鍖归厤椤癸紙鎴栬€呭彧鏈夌函鏂囨湰锛夛紝浠庡ご寮€濮?                    const walker = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);
                    centerNode = walker.nextNode();
                    centerOffset = 0;
                }

                if (!centerNode) return tempDiv.innerHTML; // 绌哄唴瀹?
                // 4. 璁＄畻鎵€鏈夋枃鏈妭鐐瑰簭鍒楋紝瀹氫綅 Range 杈圭晫
                const textNodes = [];
                const walker = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);
                let node;
                while (node = walker.nextNode()) {
                    textNodes.push(node);
                }

                // 鎵惧埌 centerNode 鍦ㄥ垪琛ㄤ腑鐨勪綅缃?                const centerIndex = textNodes.indexOf(centerNode);
                if (centerIndex === -1) return tempDiv.innerHTML;

                // 鍚戝墠/鍚戝悗绱姞瀛楃闀垮害锛屾壘鍒?startNode 鍜?endNode
                let startNode = centerNode, startOffset = centerOffset;
                let endNode = centerNode, endOffset = centerNode.textContent.length;

                // 鍚戝墠鏌ユ壘
                let remaining = limit / 2;

                // 褰撳墠鑺傜偣涔嬪墠鐨?                if (centerIndex >= 0) {
                    remaining -= centerOffset;
                    startNode = textNodes[centerIndex];
                    startOffset = Math.max(0, centerOffset - (limit / 2));
                }

                for (let j = centerIndex - 1; j >= 0; j--) {
                    const len = textNodes[j].textContent.length;
                    if (remaining <= 0) break;

                    if (remaining <= len) {
                        startNode = textNodes[j];
                        startOffset = len - remaining;
                        remaining = 0;
                    } else {
                        startNode = textNodes[j];
                        startOffset = 0;
                        remaining -= len;
                    }
                }

                // 鍚戝悗鏌ユ壘
                remaining = limit / 2;
                if (centerIndex < textNodes.length && textNodes[centerIndex]) {
                    remaining -= (textNodes[centerIndex].textContent.length - centerOffset);
                    endNode = textNodes[centerIndex];
                    endOffset = textNodes[centerIndex].textContent.length;
                }

                for (let j = centerIndex + 1; j < textNodes.length; j++) {
                    const len = textNodes[j].textContent.length;
                    if (remaining <= 0) break;

                    if (remaining <= len) {
                        endNode = textNodes[j];
                        endOffset = remaining;
                        remaining = 0;
                    } else {
                        endNode = textNodes[j];
                        endOffset = len;
                        remaining -= len;
                    }
                }

                // 5. 浣跨敤 Range 鎻愬彇鐗囨 (淇濈暀 DOM 缁撴瀯)
                try {
                    const range = document.createRange();
                    range.setStart(startNode, startOffset);
                    range.setEnd(endNode, endOffset);
                    const fragment = range.cloneContents();
                    const container = document.createElement('div');
                    container.appendChild(fragment);
                    return container.innerHTML;
                } catch (e) {
                    console.error("Range extraction failed", e);
                    return tempDiv.innerHTML; // Fallback
                }
            };

            // 鍐呴儴浣跨敤鐨?Element 楂樹寒 (涓嶈繑鍥炲瓧绗︿覆锛岀洿鎺ヤ慨鏀?DOM)
            const highlightHtmlElement = (element, keyword, maxGap = 30) => {
                const regex = createSearchRegex(keyword, maxGap);
                if (!regex) return;

                // 1. 鑾峰彇鎵€鏈夋枃鏈妭鐐瑰強鍏跺湪瀹屾暣鏂囨湰涓殑浣嶇疆
                const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
                const textNodes = [];
                let fullText = "";
                let node;
                while (node = walker.nextNode()) {
                    textNodes.push({
                        node,
                        start: fullText.length,
                        end: fullText.length + node.textContent.length
                    });
                    fullText += node.textContent;
                }

                // 2. 鏀堕泦鎵€鏈夐渶瑕侀珮浜殑绮剧‘鐗囨 (浣跨敤鎹曡幏缁勮烦杩囬棿闅?
                let match;
                const highlightRanges = [];
                regex.lastIndex = 0;

                while ((match = regex.exec(fullText)) !== null) {
                    // regex 缁撴瀯: (char)(gap)(char)(gap)...
                    // match[0] 鏄畬鏁村尮閰?                    // match[1], match[3]... 鏄叧閿瘝瀛楃 (闇€瑕侀珮浜?
                    // match[2], match[4]... 鏄棿闅?(涓嶉渶瑕侀珮浜?

                    let currentPos = match.index;

                    for (let i = 1; i < match.length; i++) {
                        const segment = match[i];
                        const len = segment ? segment.length : 0;

                        // 濂囨暟绱㈠紩涓哄叧閿瘝閮ㄥ垎 (group 1, 3, 5...)
                        if (i % 2 === 1) {
                            if (len > 0) {
                                highlightRanges.push({
                                    start: currentPos,
                                    end: currentPos + len
                                });
                            }
                        }

                        currentPos += len;
                    }

                    if (match.index === regex.lastIndex) regex.lastIndex++;
                }

                if (highlightRanges.length === 0) return;

                // 3. 灏嗛珮浜尯闂村簲鐢ㄥ埌鏂囨湰鑺傜偣 (瀹夊叏閬嶅巻)
                textNodes.forEach(tn => {
                    // 鎵惧嚭鎵€鏈夎惤鍦ㄥ綋鍓嶆枃鏈妭鐐硅寖鍥村唴鐨勯珮浜尯闂?                    const nodeMatches = [];
                    highlightRanges.forEach(range => {
                        if (range.start < tn.end && range.end > tn.start) {
                            nodeMatches.push({
                                start: Math.max(range.start, tn.start) - tn.start, // 杞负鑺傜偣鐩稿鍧愭爣
                                end: Math.min(range.end, tn.end) - tn.start
                            });
                        }
                    });

                    if (nodeMatches.length === 0) return;

                    // 鎺掑簭骞跺悎骞堕噸鍙犲尯闂?                    nodeMatches.sort((a, b) => a.start - b.start);
                    const merged = [];
                    let current = nodeMatches[0];
                    for (let i = 1; i < nodeMatches.length; i++) {
                        if (nodeMatches[i].start <= current.end) {
                            current.end = Math.max(current.end, nodeMatches[i].end);
                        } else {
                            merged.push(current);
                            current = nodeMatches[i];
                        }
                    }
                    merged.push(current);

                    // 4. 鏋勫缓鍖呭惈楂樹寒鐨?Fragment 鏇挎崲鍘熻妭鐐?                    const text = tn.node.textContent;
                    const fragment = document.createDocumentFragment();
                    let cursor = 0;

                    merged.forEach(m => {
                        if (m.start > cursor) {
                            fragment.appendChild(document.createTextNode(text.substring(cursor, m.start)));
                        }
                        const newSpan = document.createElement('mark');
                        newSpan.className = 'highlight';
                        newSpan.textContent = text.substring(m.start, m.end);
                        fragment.appendChild(newSpan);
                        cursor = m.end;
                    });

                    if (cursor < text.length) {
                        fragment.appendChild(document.createTextNode(text.substring(cursor)));
                    }

                    // 鍙湁鐖惰妭鐐瑰瓨鍦ㄦ椂鎵嶆浛鎹?(閬垮厤娼滃湪鐨勫娆℃搷浣滈棶棰?
                    if (tn.node.parentNode) {
                        tn.node.parentNode.replaceChild(fragment, tn.node);
                    }
                });
            };

            return { createSearchRegex, highlightText, getHtmlFragment };
        }

        // --- COMPONENTS ---

        // 1. NavBar
        const NavBar = {
            props: ['activeTab'],
            template: '#tmpl-nav-bar'
        };

        // 2. TabBar
        const TabBar = {
            props: ['modelValue'],
            template: '#tmpl-tab-bar'
        };

        // 3. Search View (Updated)
        const SearchView = {
            template: '#tmpl-search-view',
            setup(props, { emit }) {
                const db = useDB();
                const { createSearchRegex, highlightText, getHtmlFragment } = useSearchEngine();
                const searchInput = ref(null);

                const query = ref('');
                const results = ref([]);
                const isSearching = ref(false);
                const hasSearched = ref(false);

                // 閰嶇疆鎺у埗 (浣跨敤鍏ㄥ眬鍝嶅簲寮忛厤缃?
                const config = globalConfig;

                // 鎻愬彇椤瑰垎椤垫帶鍒?(鍏变韩 Extractor 鏁版嵁)
                const extractorStore = useStorage('extractor_v2_data', extractorDefaultState, localStorage, { mergeDefaults: true });
                const extractedList = computed(() => {
                    const rawList = extractorStore.value.extractedList || [];
                    return rawList
                        .map(item => ({
                            ...item,
                            text: (item.text || '').split('\n').filter(l => l.trim()).join('\n')
                        }))
                        .filter(item => item.text && item.text.trim() !== '');
                });
                const currentResultIndex = ref(0);
                const showSnippetDropdown = ref(false);
                const snippetDropdownRef = ref(null);

                // 鐐瑰嚮澶栭儴鍏抽棴涓嬫媺鑿滃崟
                VueUse.onClickOutside(snippetDropdownRef, () => {
                    showSnippetDropdown.value = false;
                });

                const currentExtractedText = computed(() => {
                    if (extractedList.value.length === 0) return '';
                    // 纭繚绱㈠紩涓嶈秺鐣?(濡傛灉鍒楄〃鍒犻櫎浜?
                    const normalizedIndex = Math.min(currentResultIndex.value, extractedList.value.length - 1);
                    return extractedList.value[normalizedIndex]?.text || '';
                });

                const applyResult = () => {
                    const text = currentExtractedText.value;
                    if (text) {
                        query.value = text;
                        // 寮哄埗绔嬪嵆鎵ц涓€娆★紝涓嶉渶瑕佺瓑寰?debounce
                        handleSearch();
                        if (searchInput.value) searchInput.value.blur();
                    }
                };

                const nextResult = () => {
                    if (extractedList.value.length === 0) return;
                    currentResultIndex.value = (currentResultIndex.value + 1) % extractedList.value.length;
                    applyResult();
                };

                const prevResult = () => {
                    if (extractedList.value.length === 0) return;
                    currentResultIndex.value = (currentResultIndex.value - 1 + extractedList.value.length) % extractedList.value.length;
                    applyResult();
                };

                // 1. 瀛椾綋鎺у埗 State
                const currentFontSize = ref(16);

                // 2. 鍓垏鏉挎帶鍒?State
                const { text: clipboardText, isSupported } = useClipboard();

                const pasteClipboard = () => {
                    if (clipboardText.value) {
                        query.value = clipboardText.value;
                        // 鎻掑叆鍚庡け鍘荤劍鐐癸紝绗﹀悎瑕佹眰
                        if (searchInput.value) searchInput.value.blur();
                        handleSearch();
                    }
                };

                // 3. 鏂囨。绛涢€夊姛鑳?                const showDocFilter = ref(false);
                const allDocs = ref([]);
                const selectedDocIds = reactive(new Set());

                // 浣跨敤 localStorage 鎸佷箙鍖栭€変腑鐨勬枃妗?ID
                const docFilterStorage = useStorage('doc_filter_ids', { ids: [] });

                // 鍒濆鍖栵細浠庡瓨鍌ㄦ仮澶嶉€変腑鐨勬枃妗?ID
                onMounted(async () => {
                    await loadAllDocs();
                    const storedIds = docFilterStorage.value.ids || [];
                    storedIds.forEach(id => selectedDocIds.add(id));
                });

                // 姣忔婵€娲绘椂鍒锋柊鏂囨。鍒楄〃 (瑙ｅ喅涓婁紶鍚庢棤娉曠瓫閫夌殑闂)
                onActivated(() => {
                    loadAllDocs();
                });

                // 鍔犺浇鎵€鏈夋枃妗?                const loadAllDocs = async () => {
                    try {
                        allDocs.value = await db.files.toArray();
                        // 濡傛灉娌℃湁閫変腑浠讳綍鏂囨。锛堢涓€娆′娇鐢級锛岄粯璁ゅ叏閫?                        if (selectedDocIds.size === 0 && allDocs.value.length > 0) {
                            allDocs.value.forEach(doc => selectedDocIds.add(doc.id));
                        }
                    } catch (err) {
                        console.error('鍔犺浇鏂囨。澶辫触:', err);
                    }
                };

                // 鏂囨。绛涢€夋槸鍚︽縺娲伙紙鏈夌瓫閫夋椂涓簍rue锛?                const isDocFilterActive = computed(() => {
                    return allDocs.value.length > 0 && selectedDocIds.size < allDocs.value.length && selectedDocIds.size > 0;
                });

                // 鍒囨崲鍗曚釜鏂囨。閫夋嫨
                const toggleDocSelection = (docId) => {
                    if (selectedDocIds.has(docId)) {
                        selectedDocIds.delete(docId);
                    } else {
                        selectedDocIds.add(docId);
                    }
                };

                // 鍏ㄩ€夋枃妗?                const selectAllDocs = () => {
                    allDocs.value.forEach(doc => selectedDocIds.add(doc.id));
                };

                // 鍙嶉€夋枃妗?                const invertDocSelection = () => {
                    const allIds = new Set(allDocs.value.map(doc => doc.id));
                    const newSelection = new Set();
                    allIds.forEach(id => {
                        if (!selectedDocIds.has(id)) {
                            newSelection.add(id);
                        }
                    });
                    selectedDocIds.clear();
                    newSelection.forEach(id => selectedDocIds.add(id));
                };

                // 娓呯┖鏂囨。閫夋嫨
                const clearAllDocs = () => {
                    selectedDocIds.clear();
                };

                // 搴旂敤鏂囨。绛涢€?                const applyDocFilter = () => {
                    // 淇濆瓨鍒?localStorage
                    docFilterStorage.value = { ids: Array.from(selectedDocIds) };
                    showDocFilter.value = false;
                    // 閲嶆柊瑙﹀彂鎼滅储
                    if (query.value.trim()) {
                        handleSearch();
                    }
                    showToast(`宸查€夋嫨 ${selectedDocIds.size} 涓枃妗, 'success');
                };

                // 4. 绮剧‘鎼滅储妯″紡
                const isExactSearch = ref(false);

                const toggleExactSearch = () => {
                    isExactSearch.value = !isExactSearch.value;
                    // 濡傛灉鏈夋悳绱㈠唴瀹癸紝閲嶆柊瑙﹀彂鎼滅储
                    if (query.value.trim()) {
                        handleSearch();
                    }
                };

                const handleSearch = async () => {
                    if (!query.value.trim()) return;
                    isSearching.value = true;
                    results.value = [];
                    hasSearched.value = true;

                    try {
                        // 鑾峰彇鎵€鏈夋枃浠讹紝浣嗗彧鎼滅储閫変腑鐨勬枃妗?                        const allFiles = await db.files.toArray();
                        const files = allFiles.filter(file => selectedDocIds.has(file.id));

                        if (files.length === 0) {
                            showToast('鏈€夋嫨浠讳綍鏂囨。', 'error');
                            isSearching.value = false;
                            return;
                        }

                        let hits = [];

                        if (isExactSearch.value) {
                            // 绮剧‘鎼滅储妯″紡锛氶€愬瓧鎼滅储锛屼笉鍏佽闂撮殧
                            const searchText = query.value;
                            const regex = new RegExp(escapeRegExp(searchText), 'gi');

                            for (const file of files) {
                                let fileMatchCount = 0;
                                let match;
                                regex.lastIndex = 0;

                                while ((match = regex.exec(file.content)) !== null) {
                                    if (fileMatchCount > 15) break;
                                    fileMatchCount++;

                                    const center = match.index;
                                    const matchStr = match[0];
                                    const matchLen = matchStr.length;
                                    const range = config.value.previewRange;

                                    const start = Math.max(0, center - range);
                                    const end = Math.min(file.content.length, center + matchLen + range);
                                    const rawSnippet = file.content.substring(start, end).split('\n').filter(l => l.trim()).join('\n');

                                    // 绠€鍗曢珮浜紙绮剧‘鍖归厤锛?                                    const highlighted = rawSnippet.replace(
                                        regex,
                                        match => `<mark class="highlight">${escapeHTML(match)}</mark>`
                                    );

                                    hits.push({
                                        id: file.id,
                                        fileName: file.fileName,
                                        matchIndex: center,
                                        matchLength: matchLen,
                                        highlightedSnippet: escapeHTML(rawSnippet).replace(
                                            new RegExp(escapeRegExp(escapeHTML(searchText)), 'gi'),
                                            match => `<mark class="highlight">${match}</mark>`
                                        ),
                                        fullContent: file.content,
                                        htmlContent: file.htmlContent
                                    });

                                    if (match.index === regex.lastIndex) regex.lastIndex++;
                                }
                            }
                        } else {
                            // 妯＄硦鎼滅储妯″紡锛氬厑璁搁棿闅?                            const maxGap = config.value.maxSearchGap || 30;
                            const regex = createSearchRegex(query.value, maxGap);

                            if (!regex) {
                                isSearching.value = false;
                                return;
                            }

                            for (const file of files) {
                                let fileMatchCount = 0;
                                let match;
                                regex.lastIndex = 0;

                                while ((match = regex.exec(file.content)) !== null) {
                                    if (fileMatchCount > 15) break;
                                    fileMatchCount++;

                                    const center = match.index;
                                    const matchStr = match[0];
                                    const matchLen = matchStr.length;
                                    const range = config.value.previewRange;

                                    const start = Math.max(0, center - range);
                                    const end = Math.min(file.content.length, center + matchLen + range);
                                    // 鍒楄〃棰勮缁熶竴浣跨敤绾枃鏈?(Text Preview Only)
                                    // 鍙湁杩涘叆璇︽儏椤甸瑙堟椂鎵嶆樉绀?HTML 鏍煎紡
                                    const rawSnippet = file.content.substring(start, end).split('\n').filter(l => l.trim()).join('\n');
                                    const highlightedSnippet = highlightText(rawSnippet, query.value, maxGap);

                                    hits.push({
                                        id: file.id,
                                        fileName: file.fileName,
                                        matchIndex: center,
                                        matchLength: matchLen,
                                        highlightedSnippet: highlightedSnippet,
                                        fullContent: file.content,
                                        htmlContent: file.htmlContent
                                    });

                                    if (match.index === regex.lastIndex) regex.lastIndex++;
                                }
                            }
                        }

                        // 鎺掑簭浼樺寲
                        hits.sort((a, b) => {
                            if (a.matchLength !== b.matchLength) {
                                return a.matchLength - b.matchLength;
                            }
                            return a.matchIndex - b.matchIndex;
                        });

                        results.value = hits;
                    } catch (err) {
                        console.error('鎼滅储澶辫触:', err);
                        showToast('鎼滅储澶辫触', 'error');
                    } finally {
                        isSearching.value = false;
                    }
                };

                // HTML 杞箟杈呭姪鍑芥暟
                const escapeHTML = (str) => {
                    const div = document.createElement('div');
                    div.textContent = str;
                    return div.innerHTML;
                };

                // 姝ｅ垯杞箟杈呭姪鍑芥暟
                const escapeRegExp = (str) => {
                    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                };

                const debouncedSearch = useDebounceFn(handleSearch, 800);
                watch(query, () => {
                    if (!query.value) {
                        results.value = [];
                        hasSearched.value = false;
                    } else {
                        debouncedSearch();
                    }
                });

                // 鐩戝惉閰嶇疆鍙樺寲鑷姩閲嶆悳
                watch(config, () => {
                    if (query.value) {
                        debouncedSearch();
                    }
                }, { deep: true });

                const clear = () => { query.value = ''; results.value = []; };

                return {
                    query, results, isSearching, hasSearched,
                    handleSearch, clear,
                    config, currentFontSize, // 瀛椾綋
                    clipboardText, pasteClipboard, searchInput, // 鍓垏鏉?                    extractedList, currentExtractedText, currentResultIndex, nextResult, prevResult, applyResult, // 鍒嗛〉鎺у埗
                    showSnippetDropdown, snippetDropdownRef, // 涓嬫媺閫夋嫨
                    // 鏂囨。绛涢€?                    showDocFilter, allDocs, selectedDocIds, isDocFilterActive,
                    toggleDocSelection, selectAllDocs, invertDocSelection, clearAllDocs, applyDocFilter,
                    // 绮剧‘鎼滅储
                    isExactSearch, toggleExactSearch
                };
            }
        };

        // 4. Library View
        const LibraryView = {
            template: '#tmpl-library-view',
            setup(props, { emit }) {
                const db = useDB();
                const { parseFile } = useParser();
                const files = ref([]);
                const loading = ref(true);

                const loadFiles = async () => {
                    loading.value = true;
                    files.value = await db.files.orderBy('date').reverse().toArray();
                    loading.value = false;
                };

                const onFileSelect = async (e) => {
                    const selectedFiles = Array.from(e.target.files);
                    if (!selectedFiles.length) return;

                    showToast('寮€濮嬭В鏋?..', 'info');
                    let successCount = 0;

                    for (const file of selectedFiles) {
                        try {
                            const { text, html } = await parseFile(file);
                            await db.files.add({
                                fileName: file.name,
                                content: text,
                                htmlContent: html,
                                rawBlob: file, // 瀛樺偍鍘熷鏂囦欢 Blob
                                date: new Date()
                            });
                            successCount++;
                        } catch (err) {
                            console.error(err);
                            showToast(`瑙ｆ瀽澶辫触: ${file.name}`, 'error');
                        }
                    }
                    if (successCount > 0) {
                        showToast(`鎴愬姛瀵煎叆 ${successCount} 涓枃妗);
                        loadFiles();
                    }
                };

                const deleteFile = async (id) => {
                    const ok = await showConfirm({
                        title: '鍒犻櫎鏂囨。',
                        message: '纭畾瑕佹案涔呭垹闄よ鏂囨。鍚楋紵姝ゆ搷浣滀笉鍙挙閿€銆?,
                        confirmText: '纭鍒犻櫎',
                        type: 'danger'
                    });
                    if (!ok) return;
                    await db.files.delete(id);
                    showToast('宸插垹闄?);
                    loadFiles();
                };

                const refresh = loadFiles;
                const formatDate = (d) => new Date(d).toLocaleDateString();

                onMounted(loadFiles);
                return { files, loading, onFileSelect, deleteFile, refresh, formatDate };
            }
        };

        // 5. Detail Modal
        const DetailModal = {
            props: ['modelValue', 'item', 'searchKeyword'],
            template: '#tmpl-detail-modal',
            setup(props, { emit }) {
                const isFullMode = ref(false);
                const showOriginal = ref(true); // 榛樿鏄剧ず鍘熺増 HTML 鏍峰紡
                const loading = ref(false);
                const { highlightText, getHtmlFragment } = useSearchEngine();
                const config = globalConfig;
                const scrollContainer = ref(null);
                // const originalContainer = ref(null); // 鍘熺増娓叉煋瀹瑰櫒 // REMOVED

                // 閲嶇疆鐘舵€?                watch(() => props.item, (newVal) => {
                    if (newVal && newVal.isFullPreview) {
                        isFullMode.value = true;
                    } else {
                        isFullMode.value = false;
                    }
                    showOriginal.value = true; // 鍒囨崲鏂囦欢鏃堕粯璁ゆ樉绀哄師鐗?HTML 鏍峰紡
                    // if (originalContainer.value) originalContainer.value.innerHTML = ''; // REMOVED

                    nextTick(() => {
                        if (scrollContainer.value) scrollContainer.value.scrollTop = 0;
                    });
                });

                const close = () => emit('update:modelValue', false);
                const toggleMode = () => {
                    isFullMode.value = !isFullMode.value;
                    nextTick(() => {
                        const mark = scrollContainer.value?.querySelector('mark.highlight');
                        if (mark) {
                            mark.scrollIntoView({ block: 'center', behavior: 'smooth' });
                        }
                    });
                };

                // 鍒囨崲鍘熺増/绾噣鐗?                const toggleOriginal = async () => {
                    showOriginal.value = !showOriginal.value;
                    if (showOriginal.value) {
                        // await renderOriginalFile(); // No longer needed for DOCX, PDF still uses iframe
                    }
                };

                // 鍘熺増娓叉煋閫昏緫 (浠呬繚鐣?PDF iframe)
                // const renderOriginalFile = async () => { // REMOVED
                //     const container = originalContainer.value; // REMOVED
                //     if (!container) return; // REMOVED

                //     // 妫€鏌ユ槸鍚︽湁鍘熷鏂囦欢鏁版嵁 // REMOVED
                //     if (!props.item?.rawBlob) { // REMOVED
                //         container.innerHTML = ` // REMOVED
                //             <div class="flex flex-col items-center justify-center py-10 text-slate-400 space-y-2"> // REMOVED
                //                 <i class="ph ph-warning-circle text-3xl"></i> // REMOVED
                //                 <p class="text-xs">璇ユ枃妗ｄ负鏃х増鏈紝鏈瓨鍌ㄥ師鐗堟暟鎹?/p> // REMOVED
                //                 <p class="text-[10px] opacity-75">璇峰垹闄ゅ悗閲嶆柊涓婁紶浠ユ煡鐪嬪師鐗堟牱</p> // REMOVED
                //             </div> // REMOVED
                //         `; // REMOVED
                //         return; // REMOVED
                //     } // REMOVED

                //     const file = props.item.rawBlob; // REMOVED
                //     container.innerHTML = '<div class="py-4 text-center text-slate-400 text-xs">姝ｅ湪娓叉煋鍘熺増鏍峰紡...</div>'; // REMOVED

                //     try { // REMOVED
                //         if (file.name.endsWith('.docx')) { // REMOVED
                //             // 浣跨敤 docx-preview 娓叉煋 // REMOVED
                //             await docx.renderAsync(file, container, null, { // REMOVED
                //                 className: 'docx_viewer', // REMOVED
                //                 inWrapper: true, // 寮€鍚?wrapper 浠ヤ究鎺у埗鏍峰紡 // REMOVED
                //                 ignoreWidth: false, // REMOVED
                //                 ignoreHeight: false, // REMOVED
                //                 ignoreFonts: false, // REMOVED
                //                 breakPages: true, // REMOVED
                //                 ignoreLastRenderedPageBreak: true, // REMOVED
                //                 experimental: true, // REMOVED
                //                 trimXmlDeclaration: true, // REMOVED
                //                 useBase64URL: false // REMOVED
                //             }); // REMOVED
                //         } // REMOVED
                //         else if (file.type === 'application/pdf') { // REMOVED
                //             // PDF 浣跨敤 iframe 棰勮 (Blob URL) // REMOVED
                //             const url = URL.createObjectURL(file); // REMOVED
                //             container.innerHTML = `<iframe src="${url}" class="w-full h-[80vh] border-none rounded-lg bg-slate-100"></iframe>`; // REMOVED
                //         } // REMOVED
                //         else { // REMOVED
                //             container.innerHTML = `<div class="p-4 whitespace-pre-wrap">${await file.text()}</div>`; // REMOVED
                //         } // REMOVED
                //     } catch (e) { // REMOVED
                //         console.error("Render failed", e); // REMOVED
                //         container.innerHTML = `<div class="text-red-500 p-4">娓叉煋澶辫触锛岃鍒囨崲鍥炵函鍑€妯″紡銆?/div>`; // REMOVED
                //     } // REMOVED
                // }; // REMOVED

                // Utils: 鍘婚櫎棰滆壊鏍峰紡锛屼絾淇濈暀缁撴瀯绫诲悕
                const stripStyles = (html) => {
                    if (!html) return '';
                    const div = document.createElement('div');
                    div.innerHTML = html;
                    // 鍙Щ闄?style 灞炴€э紙棰滆壊/瀛楀彿绛夛級锛屼繚鐣?class锛堢敤浜庢崲琛屾帶鍒讹級
                    const els = div.querySelectorAll('*');
                    els.forEach(el => {
                        el.removeAttribute('style');
                        // 淇濈暀 docx-p 绫诲悕锛岀敤浜庢崲琛?                        const classes = el.getAttribute('class');
                        if (classes && !classes.includes('docx-p')) {
                            el.removeAttribute('class');
                        }
                    });
                    return div.innerHTML;
                };

                // 灏嗙函鏂囨湰杞崲涓哄甫鎹㈣鐨?HTML
                const textToHtml = (text) => {
                    if (!text) return '';
                    // 杞箟 HTML 鐗规畩瀛楃
                    const escaped = text.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
                    // 灏嗘崲琛岀杞崲涓?<br> 鎴?div锛岀‘淇濇瘡琛屾樉绀?                    return escaped.split('\n').map(line => `<div class="docx-p">${line || '<br>'}</div>`).join('');
                };

                // 閽堝 HTML 鍐呭鐨勪笓鐢ㄩ珮浜绠?                const highlightedHtml = computed(() => {
                    // 1. 鑾峰彇鍩虹 HTML (浼樺厛浣跨敤 htmlContent锛屽惁鍒欎粠 fullContent 鐢熸垚)
                    let baseHtml = props.item?.htmlContent || '';

                    // 濡傛灉娌℃湁 htmlContent锛屼粠绾枃鏈?fullContent 鐢熸垚
                    if (!baseHtml && props.item?.fullContent) {
                        baseHtml = textToHtml(props.item.fullContent);
                    }

                    if (!baseHtml) return '<div class="text-slate-400 py-4">鏃犲唴瀹瑰彲鏄剧ず</div>';

                    // 2. 绾噣妯″紡锛氬幓闄ら鑹叉牱寮忥紝浣嗕繚鐣欑粨鏋?                    if (!showOriginal.value) {
                        baseHtml = stripStyles(baseHtml);
                    }

                    // 3. 搴旂敤鎼滅储楂樹寒 (鍦?HTML 缁撴瀯涔嬩笂鍙犲姞)
                    // 濡傛灉鏄墖娈垫ā寮忥紝浣跨敤 getHtmlFragment 杩涜鎴彇
                    if (!isFullMode.value) {
                        const range = config.value.detailRange || 500;
                        return getHtmlFragment(baseHtml, props.searchKeyword, 30, range);
                    } else {
                        // 鍏ㄦ枃妯″紡锛氬彧楂樹寒涓嶆埅鍙?                        if (props.searchKeyword) {
                            return getHtmlFragment(baseHtml, props.searchKeyword, 30, 0);
                        }
                        return baseHtml;
                    }
                });

                const displayContent = computed(() => {
                    // 缁熶竴閫昏緫锛氭棤璁烘槸鍏ㄦ枃杩樻槸鐗囨锛岀幇鍦ㄩ兘浣跨敤 HTML 娓叉煋
                    // 鍥犱负鎵嬪姩瑙ｆ瀽鍣ㄥ凡缁忓皢 text 鏄犲皠涓轰簡甯︾粨鏋勭殑 p/span
                    // 鐗囨妯″紡鏆傛椂鐩存帴鏄剧ず鍏ㄦ枃锛堥€氳繃婊氬姩瀹氫綅锛夛紝鎴栬€呮槸鏄剧ず甯﹂珮浜殑 HTML
                    // 涓轰簡鍝嶅簲鐢ㄦ埛鈥滃嵆浣垮湪棰勮鎴彇涓篃鏀寔棰勮鈥濈殑闇€姹傦紝鏈€绋冲Ε鐨勬柟寮忔槸锛?                    // 鏃㈢劧鏈変簡 Rich HTML锛屽氨灏介噺灞曠ず HTML銆?
                    // 鐩墠绠€鍖栧鐞嗭細鍏ㄩ儴浣跨敤 highlightedHtml銆?                    // DetailModal 鐨勫鍣ㄦ帶鍒朵簡 scroll锛屾垜浠彲浠ュ湪 openDetail 鏃惰嚜鍔ㄦ粴鍔ㄥ埌鍖归厤浣嶇疆銆?                    return highlightedHtml.value;
                });

                // 鐩戝惉鎵撳紑锛岃嚜鍔ㄦ粴鍔ㄥ埌楂樹寒浣嶇疆
                watch(() => props.item, (val) => {
                    if (val && !val.isFullPreview) {
                        // 鐗囨妯″紡锛氬皾璇曞畾浣嶅埌绗竴涓?<mark>
                        nextTick(() => {
                            const mark = scrollContainer.value?.querySelector('mark.highlight');
                            if (mark) {
                                mark.scrollIntoView({ block: 'center', behavior: 'smooth' });
                            }
                        });
                    }
                });

                const currentFontSize = ref(16);

                return {
                    close, isFullMode, toggleMode, toggleOriginal, showOriginal,
                    loading, displayContent, highlightedHtml, currentFontSize,
                    config, scrollContainer
                };
            }
        };

        // 6. Extractor View
        const ExtractorView = {
            template: '#tmpl-extractor-view',
            setup() {
                // 涓哄凡鎻愬彇椤圭敓鎴愰鑹茶皟鑹叉澘锛堝甫閫忔槑搴︼級
                const colorPalette = [
                    '#6366f1', '#8b5cf6', '#ec4899', '#ef4444', '#f59e0b',
                    '#10b981', '#06b6d4', '#3b82f6', '#d946ef', '#f97316'
                ];

                // --- 鐘舵€佹寔涔呭寲鏍稿績閫昏緫 (浼樺寲锛氫娇鐢?useStorage) ---
                const storageState = useStorage('extractor_v2_data', extractorDefaultState, localStorage, { mergeDefaults: true });

                // 鍝嶅簲寮忕姸鎬佹槧灏?                const currentStep = toRef(storageState.value, 'currentStep');
                const innerTab = toRef(storageState.value, 'innerTab');
                const rawText = toRef(storageState.value, 'rawText');
                const hideSpaces = toRef(storageState.value, 'hideSpaces');

                // 澶嶆潅瀵硅薄澶勭悊骞跺垵濮嬪寲棰滆壊绋冲畾鎬?                const extractedList = reactive((storageState.value.extractedList || [])
                    .map((item, idx) => {
                        const text = (item.text || '').split('\n').filter(l => l.trim()).join('\n');
                        return {
                            ...item,
                            text,
                            indices: new Set(item.indices),
                            color: item.color || colorPalette[idx % colorPalette.length]
                        };
                    })
                    .filter(item => item.text && item.text.trim() !== ''));

                // 鐩戝惉 extractedList 鍙樺寲鍚屾鍥?storage
                watch(extractedList, (newVal) => {
                    storageState.value.extractedList = newVal.map(item => ({
                        ...item,
                        indices: Array.from(item.indices)
                    }));
                }, { deep: true });

                const charList = computed(() => (rawText.value || '').split(''));

                // Set涓嶴torage Array鐨勫悓姝?                // 鍒濆鍖?Set
                const selectedIndices = ref(new Set(storageState.value.selectedIndices));

                // 鐩戝惉 Set 鍙樺寲鍚屾鍥?storage
                watch(selectedIndices, (newSet) => {
                    storageState.value.selectedIndices = Array.from(newSet);
                }, { deep: true });

                const editingIndex = ref(-1);

                // 鑾峰彇鍏ㄥ眬閰嶇疆
                const config = globalConfig;

                // --- Logic: Selection ---
                // selectedIndices 宸插湪涓婃柟鎸佷箙鍖栭€昏緫涓畾涔?                const isDragging = ref(false);
                const dragMode = ref(true); // true = select, false = deselect

                const toggleIndex = (index, mode) => {
                    if (mode) selectedIndices.value.add(index);
                    else selectedIndices.value.delete(index);
                };

                const initSelection = () => {
                    if (!rawText.value || !rawText.value.trim()) return;
                    currentStep.value = 'work';
                    innerTab.value = 'select';
                };

                const handleAction = () => {
                    if (selectedIndices.value.size === 0) return;

                    const indices = Array.from(selectedIndices.value).sort((a, b) => a - b);
                    let text = indices.map(i => charList.value[i]).join('');
                    // 淇濈暀鎹㈣锛屽彧鍘婚櫎绌虹櫧琛?                    text = text.split('\n').filter(l => l.trim()).join('\n');

                    if (!text.trim()) {
                        showToast('鏃犳硶鎻愬彇绌虹櫧鍐呭', 'error');
                        return;
                    }
                    const newItem = {
                        text,
                        indices: new Set(selectedIndices.value),
                        color: editingIndex.value === -1
                            ? colorPalette[extractedList.length % colorPalette.length]
                            : extractedList[editingIndex.value].color
                    };

                    if (editingIndex.value === -1) {
                        extractedList.unshift(newItem);
                        showToast('宸叉彁鍙?);
                    } else {
                        extractedList[editingIndex.value] = newItem;
                        editingIndex.value = -1;
                        showToast('宸叉洿鏂?);
                    }

                    selectedIndices.value = new Set();
                    // 涓嶈嚜鍔ㄥ垏鎹㈠埌鍒楄〃tab锛屼繚鎸佸湪閫夊瓧妯″紡
                    // innerTab.value = 'list';
                };

                const editItem = (index) => {
                    editingIndex.value = index;
                    selectedIndices.value = new Set(extractedList[index].indices);
                    innerTab.value = 'select';
                };

                const removeItem = (index) => {
                    extractedList.splice(index, 1);
                    if (editingIndex.value === index) {
                        editingIndex.value = -1;
                        selectedIndices.value = new Set();
                    }
                    showToast('宸插垹闄?);
                };

                const { text: clipboardText, copy: copyToClipboard } = useClipboard();

                // Touch Handling
                const onGridTouchStart = (e) => {
                    const touch = e.touches[0];
                    const el = document.elementFromPoint(touch.clientX, touch.clientY);
                    const index = parseInt(el?.dataset?.index);

                    if (!isNaN(index)) {
                        isDragging.value = true;
                        dragMode.value = !selectedIndices.value.has(index);
                        toggleIndex(index, dragMode.value);
                    }
                };

                const onGridTouchMove = (e) => {
                    if (!isDragging.value) return;
                    const touch = e.touches[0];
                    const el = document.elementFromPoint(touch.clientX, touch.clientY);
                    const index = parseInt(el?.dataset?.index);

                    if (!isNaN(index)) {
                        toggleIndex(index, dragMode.value);
                    }
                };

                const onGridTouchEnd = () => {
                    isDragging.value = false;
                };

                const pasteFromClipboard = async () => {
                    try {
                        // 浼樺厛灏濊瘯鐩存帴璇诲彇
                        if (typeof navigator !== 'undefined' && navigator.clipboard && typeof navigator.clipboard.readText === 'function') {
                            const content = await navigator.clipboard.readText();
                            if (content) {
                                rawText.value = content;
                                showToast('宸蹭粠鍓垏鏉垮啓鍏?);
                                return;
                            }
                        }

                        // 濡傛灉澶辫触锛屽皾璇曚娇鐢?VueUse 缂撳瓨鐨勫唴瀹?(闇€瑕佹祻瑙堝櫒鏀寔骞朵箣鍓嶈幏鍙栬繃鏉冮檺)
                        if (clipboardText.value) {
                            rawText.value = clipboardText.value;
                            showToast('宸蹭粠鍓垏鏉垮啓鍏?);
                        } else {
                            throw new Error('Clipboard extraction failed');
                        }
                    } catch (err) {
                        console.error('Failed to read clipboard:', err);
                        showToast('鐜闄愬埗(闈濰TTPS)锛岃鎵嬪姩绮樿创', 'error');
                    }
                };

                const copyItem = (text) => {
                    copyToClipboard(text);
                    showToast('宸插鍒跺埌鍓垏鏉?);
                };

                // hideSpaces 宸插湪涓婃柟鎸佷箙鍖栭€昏緫涓畾涔?
                const clearSymbols = () => {
                    // 淇濈暀姹夊瓧銆佸瓧姣嶃€佹暟瀛楀拰绌烘牸锛屾竻闄ゅ叾浠栫鍙?                    const oldText = rawText.value;
                    rawText.value = rawText.value.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g, '');
                    if (oldText !== rawText.value) {
                        selectedIndices.value = new Set();
                        showToast('宸叉竻闄ょ鍙?);
                    }
                };

                const selectAll = () => {
                    const newSet = new Set();
                    charList.value.forEach((char, index) => {
                        if (!hideSpaces.value || char.trim() !== '') {
                            newSet.add(index);
                        }
                    });
                    selectedIndices.value = newSet;
                };

                const invertSelection = () => {
                    const newSet = new Set();
                    charList.value.forEach((char, index) => {
                        if (!hideSpaces.value || char.trim() !== '') {
                            if (!selectedIndices.value.has(index)) {
                                newSet.add(index);
                            }
                        }
                    });
                    selectedIndices.value = newSet;
                };

                const clearAllResults = async () => {
                    if (extractedList.length === 0) return;

                    const ok = await showConfirm({
                        title: '娓呯┖缁撴灉',
                        message: '纭畾瑕佹竻绌烘墍鏈夌殑鎻愬彇缁撴灉鍚楋紵',
                        confirmText: '绔嬪嵆娓呯┖',
                        type: 'danger'
                    });

                    if (ok) {
                        extractedList.splice(0, extractedList.length);
                        editingIndex.value = -1;
                        selectedIndices.value = new Set();
                        showToast('宸叉竻绌烘墍鏈夌粨鏋?);
                    }
                };

                // 鑾峰彇宸叉彁鍙栭」鐨勯鑹诧紙浼樺厛浣跨敤椤硅嚜甯︾殑棰滆壊锛屽疄鐜伴鑹茬ǔ瀹氭€э級
                const getExtractedColor = (itemIndex) => {
                    const item = extractedList[itemIndex];
                    return (item && item.color) ? item.color : colorPalette[itemIndex % colorPalette.length];
                };

                // 妫€鏌ュ瓧绗︽槸鍚﹀湪宸叉彁鍙栧垪琛ㄤ腑锛岃繑鍥為」鐩储寮曪紙-1琛ㄧず鏈彁鍙栵級
                const getExtractedItemIndex = (charIndex) => {
                    for (let i = 0; i < extractedList.length; i++) {
                        if (extractedList[i].indices && extractedList[i].indices.has(charIndex)) {
                            return i;
                        }
                    }
                    return -1;
                };

                // 鑾峰彇宸叉彁鍙栧瓧绗︾殑鏍峰紡锛堝甫閫忔槑搴︼級
                const getExtractedStyle = (charIndex) => {
                    const itemIndex = getExtractedItemIndex(charIndex);
                    if (itemIndex === -1) return {};
                    const color = getExtractedColor(itemIndex);
                    return {
                        backgroundColor: color + '33', // 娣诲姞20%閫忔槑搴?                        borderColor: color + '66', // 杈规40%閫忔槑搴?                        color: color
                    };
                };

                return {
                    currentStep, innerTab, rawText, charList, extractedList,
                    selectedIndices, editingIndex, config, hideSpaces,
                    initSelection, handleAction, editItem, removeItem, copyItem,
                    onGridTouchStart, onGridTouchMove, onGridTouchEnd,
                    pasteFromClipboard, clearSymbols, selectAll, invertSelection,
                    clearAllResults, getExtractedItemIndex, getExtractedStyle, getExtractedColor
                };
            }
        };

        // 7. Settings Modal (Updated)
        const SettingsModal = {
            props: ['modelValue'],
            template: `
                <div v-if="modelValue" class="absolute inset-0 z-[60] flex items-center justify-center p-4">
                    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" @click="$emit('update:modelValue', false)"></div>
                    <div class="bg-white rounded-2xl w-full max-w-sm p-6 relative shadow-2xl space-y-6 z-10">
                        <h3 class="text-lg font-bold text-slate-800">鍋忓ソ璁剧疆</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-slate-600 block mb-2">鍒楄〃棰勮瀛楁暟 (瀛楃)</label>
                                <input type="number" v-model.number="config.previewRange" min="10" max="1000" step="10" class="w-full bg-slate-100 rounded-xl px-3 py-2 text-sm border-none focus:ring-2 focus:ring-indigo-500 transition-all">
                            </div>
                            
                            <!-- 鏂板閰嶇疆椤?-->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-slate-600 block mb-2">鏈€灏忓瓧浣?(px)</label>
                                    <input type="number" v-model.number="config.minFontSize" class="w-full bg-slate-100 rounded-xl px-3 py-2 text-sm border-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-slate-600 block mb-2">鏈€澶у瓧浣?(px)</label>
                                    <input type="number" v-model.number="config.maxFontSize" class="w-full bg-slate-100 rounded-xl px-3 py-2 text-sm border-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>

                            <div>
                                <label class="text-sm font-medium text-slate-600 block mb-2">鎼滅储瀛楅棿璺濇渶澶ч檺鍒?(瀛楃)</label>
                                <p class="text-xs text-slate-400 mb-2">涓や釜鍏抽敭瀛椾箣闂寸殑璺濈瓒呰繃姝ゅ€煎皢涓嶅啀鍖归厤銆?/p>
                                <input type="number" v-model.number="config.maxSearchGap" min="1" max="500" step="1" class="w-full bg-slate-100 rounded-xl px-3 py-2 text-sm border-none focus:ring-2 focus:ring-indigo-500 transition-all">
                            </div>

                            <div>
                                <label class="text-sm font-medium text-slate-600 block mb-2">璇︽儏涓婁笅鏂囪寖鍥?(瀛楃)</label>
                                <input type="number" v-model.number="config.detailRange" min="100" max="5000" step="50" class="w-full bg-slate-100 rounded-xl px-3 py-2 text-sm border-none focus:ring-2 focus:ring-indigo-500 transition-all">
                            </div>

                            <div>
                                <label class="text-sm font-medium text-slate-600 block mb-2">閫夊瓧鏍兼渶灏忓搴?(px)</label>
                                <input type="number" v-model.number="config.charGridWidth" min="20" max="100" step="1" class="w-full bg-slate-100 rounded-xl px-3 py-2 text-sm border-none focus:ring-2 focus:ring-indigo-500 transition-all">
                            </div>
                        </div>

                        <div class="flex justify-end">
                             <button @click="save" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-medium active:scale-95 transition-transform">淇濆瓨骞剁敓鏁?/button>
                        </div>
                    </div>
                </div>
            `,
            setup(props, { emit }) {
                // 鐩存帴浣跨敤鍏ㄥ眬閰嶇疆锛屾棤闇€鎵嬪姩淇濆瓨閫昏緫
                const config = globalConfig;

                const save = () => {
                    // 鍥犱负鏄搷搴斿紡鐨勶紝鏁版嵁宸茬粡鏇存柊锛屼粎闇€鍏抽棴寮圭獥
                    emit('update:modelValue', false);
                    showToast('璁剧疆宸蹭繚瀛?);
                };
                return { config, save };
            }
        };


        // --- MAIN APP ---
        const App = {
            components: { NavBar, TabBar, SearchView, LibraryView, ExtractorView, DetailModal, SettingsModal, ToastMessage, ConfirmModal },
            setup() {
                const activeTab = ref('search');
                const showDetail = ref(false);
                const showSettings = ref(false);
                const detailItem = ref(null);
                const currentSearchKeyword = ref('');

                const openDetail = (item) => {
                    detailItem.value = item;
                    currentSearchKeyword.value = item.keyword || '';
                    showDetail.value = true;
                };

                const openPreview = (file) => {
                    detailItem.value = {
                        ...file,
                        fullContent: file.content,
                        isFullPreview: true
                    };
                    currentSearchKeyword.value = '';
                    showDetail.value = true;
                };

                return {
                    activeTab, showDetail, showSettings, detailItem,
                    currentSearchKeyword, openDetail, openPreview
                };
            }
        };

        createApp(App).mount('#app');


        document.addEventListener('backbutton', function (e) {
            e.preventDefault(); // 鎷︽埅鍘熺敓杩斿洖
            // 鎵ц鍒囨崲閫昏緫
        }, false);
    </script>
</body>

</html>
